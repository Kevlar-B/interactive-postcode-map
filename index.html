<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Service Coverage Editor</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --solar-color: #FFD700;
            --heatpump-color: #007BFF;
            --ev-color: #28A745;
            --inactive-color: #6c757d;
            --background-color: #f8f9fa;
            --border-color: #dee2e6;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background-color: #e9ecef; }
        .main-container { display: flex; flex-grow: 1; overflow: hidden; }
        #map { flex-grow: 1; height: 100%; }
        header, .control-bar { padding: 10px 20px; background-color: var(--background-color); border-bottom: 1px solid var(--border-color); }
        h1 { margin: 0; font-size: 1.5em; }
        .control-bar { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .control-bar strong { font-weight: 600; }
        #filter-controls { display: flex; gap: 20px; }
        #filter-controls label, #edit-panel-toggles label { cursor: pointer; font-size: 0.9em; display: flex; align-items: center; }
        #filter-controls input, #edit-panel-toggles input { margin-right: 8px; }
        #download-btn { padding: 8px 12px; border: 1px solid var(--border-color); background-color: white; border-radius: 5px; cursor: pointer; font-weight: 600; }
        #download-btn:hover { background-color: #f1f1f1; }

        /* Modern Legend */
        .legend {
            padding: 10px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px var(--shadow-color);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        .legend strong { display: block; margin-bottom: 5px; }

        /* Edit Panel */
        #edit-panel {
            width: 280px;
            padding: 20px;
            background-color: white;
            box-shadow: -2px 0 10px var(--shadow-color);
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1001; /* Above map controls */
        }
        #edit-panel.visible { transform: translateX(0); }
        #edit-panel h3 { margin-top: 0; }
        #edit-panel-toggles { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        #close-edit-panel { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #888; }
        #close-edit-panel:hover { color: #000; }
    </style>
</head>
<body>
    <header><h1>Interactive Service Coverage Editor</h1></header>
    <div class="control-bar">
        <strong>Filter by service:</strong>
        <div id="filter-controls">
            <label><input type="checkbox" id="solar-filter" checked> Solar Panels</label>
            <label><input type="checkbox" id="heatpump-filter" checked> Heat Pumps</label>
            <label><input type="checkbox" id="ev-filter" checked> EV Chargers</label>
        </div>
        <button id="download-btn">Download Updated CSV</button>
    </div>

    <div class="main-container">
        <div id="map"></div>
        <div id="edit-panel">
            <button id="close-edit-panel" title="Close">&times;</button>
            <h3 id="edit-panel-title">Edit Services</h3>
            <p>Toggle services for the selected postcode area.</p>
            <div id="edit-panel-toggles">
                <label><input type="checkbox" data-service="hasSolar"> Solar Panels</label>
                <label><input type="checkbox" data-service="hasHeatPump"> Heat Pumps</label>
                <label><input type="checkbox" data-service="hasEv"> EV Chargers</label>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & DOM Elements--- //
        const COLORS = {
            solar: 'var(--solar-color)',
            heatpump: 'var(--heatpump-color)',
            ev: 'var(--ev-color)',
            none: 'var(--inactive-color)'
        };
        const editPanel = document.getElementById('edit-panel');
        let geoJsonLayer;
        let serviceDataByArea = new Map();
        let currentlyEditingArea = null;

        // --- Map Initialization --- //
        const bounds = L.latLngBounds(L.latLng(49, -11), L.latLng(61, 2));
        const map = L.map('map', {
            maxBounds: bounds,
            minZoom: 5
        }).setView([54.5, -2.5], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- Embedded Initial Data (CSV & GeoJSON) --- //
        const csvData = `Region,Solar Panels,Heat Pumps,Ev Chargers
BD1,0,1,1
BD2,0,1,1
BD3,0,1,1
BD4,0,1,1
BD5,0,1,1
BD6,0,1,1
BD7,0,1,1
BD8,0,1,1
BD9,0,1,1
BD10,0,1,1
BD11,0,1,1
BD12,0,1,1
BD13,0,1,1
BD14,0,1,1
BD15,0,1,1
BD16,0,1,1
BD17,0,1,1
BD18,0,1,1
BD19,0,1,1
BD20,0,1,1
BD21,0,1,1
BD22,0,1,1
BD23,0,1,1
BD24,0,1,1
BD97,0,1,1
BD98,0,1,1
BD99,0,1,1
HG1,0,1,1
HG2,0,1,1
HG3,0,1,1
HG4,0,1,1
HG5,0,1,1
PR0,0,1,1
PR1,0,1,1
PR2,0,1,1
PR3,0,1,1
PR4,0,1,1
PR5,0,1,1
PR6,0,1,1
PR7,0,1,1
PR8,0,1,1
PR9,0,1,1
PR11,0,1,1
PR25,0,1,1
PR26,0,1,1
BB0,0,1,1
BB1,0,1,1
BB2,0,1,1
BB3,0,1,1
BB4,0,1,1
BB5,0,1,1
BB6,0,1,1
BB7,0,1,1
BB8,0,1,1
BB9,0,1,1
BB10,0,1,1
BB11,0,1,1
BB12,0,1,1
BB18,0,1,1
BB94,0,1,1
L1,0,1,1
L2,0,1,1
L3,0,1,1
L4,0,1,1
L5,0,1,1
L6,0,1,1
L7,0,1,1
L8,0,1,1
L9,0,1,1
L10,0,1,1
L11,0,1,1
L12,0,1,1
L13,0,1,1
L14,0,1,1
L15,0,1,1
L16,0,1,1
L17,0,1,1
L18,0,1,1
L19,0,1,1
L20,0,1,1
L21,0,1,1
L22,0,1,1
L23,0,1,1
L24,0,1,1
L25,0,1,1
L26,0,1,1
L27,0,1,1
L28,0,1,1
L29,0,1,1
L30,0,1,1
L31,0,1,1
L32,0,1,1
L33,0,1,1
L34,0,1,1
L35,0,1,1
L36,0,1,1
L37,0,1,1
L38,0,1,1
L39,0,1,1
L40,0,1,1
L67,0,1,1
L68,0,1,1
L69,0,1,1
L70,0,1,1
L71,0,1,1
L72,0,1,1
L73,0,1,1
L74,0,1,1
L75,0,1,1
L80,0,1,1
WN1,0,1,1
WN2,0,1,1
WN3,0,1,1
WN4,0,1,1
WN5,0,1,1
WN6,0,1,1
WN7,0,1,1
WN8,0,1,1
BL0,0,1,1
BL1,0,1,1
BL2,0,1,1
BL3,0,1,1
BL4,0,1,1
BL5,0,1,1
BL6,0,1,1
BL7,0,1,1
BL8,0,1,1
BL9,0,1,1
OL1,0,1,1
OL2,0,1,1
OL3,0,1,1
OL4,0,1,1
OL5,0,1,1
OL6,0,1,1
OL7,0,1,1
OL8,0,1,1
OL9,0,1,1
OL10,0,1,1
OL11,0,1,1
OL12,0,1,1
OL13,0,1,1
OL14,0,1,1
OL15,0,1,1
OL16,0,1,1
OL95,0,1,1
HX1,0,1,1
HX2,0,1,1
HX3,0,1,1
HX4,0,1,1
HX5,0,1,1
HX6,0,1,1
HX7,0,1,1
HD1,0,1,1
HD2,0,1,1
HD3,0,1,1
HD4,0,1,1
HD5,0,1,1
HD6,0,1,1
HD7,0,1,1
HD8,0,1,1
HD9,0,1,1
WF1,0,1,1
WF2,0,1,1
WF3,0,1,1
WF4,0,1,1
WF5,0,1,1
WF6,0,1,1
WF7,0,1,1
WF8,0,1,1
WF9,0,1,1
WF10,0,1,1
WF11,0,1,1
WF12,0,1,1
WF13,0,1,1
WF14,0,1,1
WF15,0,1,1
WF16,0,1,1
WF17,0,1,1
WF90,0,1,1
DN1,0,1,1
DN2,0,1,1
DN3,0,1,1
DN4,0,1,1
DN5,0,1,1
DN6,0,1,1
DN7,0,1,1
DN8,0,1,1
DN9,0,1,1
DN10,0,1,1
DN11,0,1,1
DN12,0,1,1
DN14,0,1,1
DN15,0,1,1
DN16,0,1,1
DN17,0,1,1
DN18,0,1,1
DN19,0,1,1
DN20,0,1,1
DN21,0,1,1
DN22,0,1,1
DN31,0,1,1
DN32,0,1,1
DN33,0,1,1
DN34,0,1,1
DN35,0,1,1
DN36,0,1,1
DN37,0,1,1
DN38,0,1,1
DN39,0,1,1
DN40,0,1,1
DN41,0,1,1
DN55,0,1,1
CH1,0,1,1
CH2,0,1,1
CH3,0,1,1
CH4,0,1,1
CH5,0,1,1
CH6,0,1,1
CH7,0,1,1
CH8,0,1,1
CH25,0,1,1
CH26,0,1,1
CH27,0,1,1
CH28,0,1,1
CH29,0,1,1
CH30,0,1,1
CH31,0,1,1
CH32,0,1,1
CH33,0,1,1
CH34,0,1,1
CH41,0,1,1
CH42,0,1,1
CH43,0,1,1
CH44,0,1,1
CH45,0,1,1
CH46,0,1,1
CH47,0,1,1
CH48,0,1,1
CH49,0,1,1
CH60,0,1,1
CH61,0,1,1
CH62,0,1,1
CH63,0,1,1
CH64,0,1,1
CH65,0,1,1
CH66,0,1,1
CH88,0,1,1
CH99,0,1,1
CW1,0,1,1
CW2,0,1,1
CW3,0,1,1
CW4,0,1,1
CW5,0,1,1
CW6,0,1,1
CW7,0,1,1
CW8,0,1,1
CW9,0,1,1
CW10,0,1,1
CW11,0,1,1
CW12,0,1,1
CW98,0,1,1
WA1,0,1,1
WA2,0,1,1
WA3,0,1,1
WA4,0,1,1
WA5,0,1,1
WA6,0,1,1
WA7,0,1,1
WA8,0,1,1
WA9,0,1,1
WA10,0,1,1
WA11,0,1,1
WA12,0,1,1
WA13,0,1,1
WA14,0,1,1
WA15,0,1,1
WA16,0,1,1
WA55,0,1,1
WA88,0,1,1
M1,0,1,1
M2,0,1,1
M3,0,1,1
M4,0,1,1
M5,0,1,1
M6,0,1,1
M7,0,1,1
M8,0,1,1
M9,0,1,1
M11,0,1,1
M12,0,1,1
M13,0,1,1
M14,0,1,1
M15,0,1,1
M16,0,1,1
M17,0,1,1
M18,0,1,1
M19,0,1,1
M20,0,1,1
M21,0,1,1
M22,0,1,1
M23,0,1,1
M24,0,1,1
M25,0,1,1
M26,0,1,1
M27,0,1,1
M28,0,1,1
M29,0,1,1
M30,0,1,1
M31,0,1,1
M32,0,1,1
M33,0,1,1
M34,0,1,1
M35,0,1,1
M38,0,1,1
M40,0,1,1
M41,0,1,1
M43,0,1,1
M44,0,1,1
M45,0,1,1
M46,0,1,1
M50,0,1,1
M60,0,1,1
M61,0,1,1
M90,0,1,1
M99,0,1,1
SK1,0,1,1
SK2,0,1,1
SK3,0,1,1
SK4,0,1,1
SK5,0,1,1
SK6,0,1,1
SK7,0,1,1
SK8,0,1,1
SK9,0,1,1
SK10,0,1,1
SK11,0,1,1
SK12,0,1,1
SK13,0,1,1
SK14,0,1,1
SK15,0,1,1
SK16,0,1,1
SK17,0,1,1
SK22,0,1,1
SK23,0,1,1
S1,0,1,1
S2,0,1,1
S3,0,1,1
S4,0,1,1
S5,0,1,1
S6,0,1,1
S7,0,1,1
S8,0,1,1
S9,0,1,1
S10,0,1,1
S11,0,1,1
S12,0,1,1
S13,0,1,1
S14,0,1,1
S17,0,1,1
S18,0,1,1
S19,0,1,1
S20,0,1,1
S21,0,1,1
S25,0,1,1
S26,0,1,1
S30,0,1,1
S31,0,1,1
S32,0,1,1
S33,0,1,1
S35,0,1,1
S36,0,1,1
S40,0,1,1
S41,0,1,1
S42,0,1,1
S43,0,1,1
S44,0,1,1
S45,0,1,1
S49,0,1,1
S60,0,1,1
S61,0,1,1
S62,0,1,1
S63,0,1,1
S64,0,1,1
S65,0,1,1
S66,0,1,1
S70,0,1,1
S71,0,1,1
S72,0,1,1
S73,0,1,1
S74,0,1,1
S75,0,1,1
S80,0,1,1
S81,0,1,1
S94,0,1,1
S95,0,1,1
S96,0,1,1
S97,0,1,1
S98,0,1,1
S99,0,1,1
DE1,0,1,1
DE3,0,1,1
DE4,0,1,1
DE5,0,1,1
DE6,0,1,1
DE7,0,1,1
DE11,0,1,1
DE12,0,1,1
DE13,0,1,1
DE14,0,1,1
DE15,0,1,1
DE21,0,1,1
DE22,0,1,1
DE23,0,1,1
DE24,0,1,1
DE45,0,1,1
DE55,0,1,1
DE56,0,1,1
DE65,0,1,1
DE72,0,1,1
DE73,0,1,1
DE74,0,1,1
DE75,0,1,1
DE99,0,1,1
NG1,0,1,1
NG2,0,1,1
NG3,0,1,1
NG4,0,1,1
NG5,0,1,1
NG6,0,1,1
NG7,0,1,1
NG8,0,1,1
NG9,0,1,1
NG10,0,1,1
NG11,0,1,1
NG12,0,1,1
NG13,0,1,1
NG14,0,1,1
NG15,0,1,1
NG16,0,1,1
NG17,0,1,1
NG18,0,1,1
NG19,0,1,1
NG20,0,1,1
NG21,0,1,1
NG22,0,1,1
NG23,0,1,1
NG24,0,1,1
NG25,0,1,1
NG31,0,1,1
NG32,0,1,1
NG33,0,1,1
NG34,0,1,1
NG70,0,1,1
NG80,0,1,1
NG90,0,1,1
LS1,0,1,1
LS2,0,1,1
LS3,0,1,1
LS4,0,1,1
LS5,0,1,1
LS6,0,1,1
LS7,0,1,1
LS8,0,1,1
LS9,0,1,1
LS10,0,1,1
LS11,0,1,1
LS12,0,1,1
LS13,0,1,1
LS14,0,1,1
LS15,0,1,1
LS16,0,1,1
LS17,0,1,1
LS18,0,1,1
LS19,0,1,1
LS20,0,1,1
LS21,0,1,1
LS22,0,1,1
LS23,0,1,1
LS24,0,1,1
LS25,0,1,1
LS26,0,1,1
LS27,0,1,1
LS28,0,1,1
LS29,0,1,1
FY0,0,1,1
FY1,0,1,1
FY2,0,1,1
FY3,0,1,1
FY4,0,1,1
FY5,0,1,1
FY6,0,1,1
FY7,0,1,1
FY8,0,1,1
OX7,1,0,0
OX9,1,0,0
`;
        const geoJsonData = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"AB"},"geometry":{"type":"Polygon","coordinates":[[[-2.22,57.14],[-2.12,57.17],[-2.09,57.15],[-2.09,57.14],[-2.14,57.11],[-2.22,57.14]]]}},{"type":"Feature","properties":{"name":"AL"},"geometry":{"type":"Polygon","coordinates":[[[-0.22,51.75],[-0.2,51.76],[-0.22,51.78],[-0.26,51.78],[-0.27,51.75],[-0.22,51.75]]]}},{"type":"Feature","properties":{"name":"B"},"geometry":{"type":"Polygon","coordinates":[[[-1.83,52.49],[-1.8,52.49],[-1.79,52.51],[-1.8,52.54],[-1.82,52.56],[-1.87,52.56],[-1.9,52.55],[-1.93,52.52],[-1.93,52.48],[-1.9,52.47],[-1.83,52.49]]]}},{"type":"Feature","properties":{"name":"BA"},"geometry":{"type":"Polygon","coordinates":[[[-2.49,51.29],[-2.37,51.38],[-2.34,51.38],[-2.33,51.36],[-2.36,51.31],[-2.32,51.25],[-2.39,51.18],[-2.5,51.16],[-2.59,51.21],[-2.55,51.27],[-2.49,51.29]]]}},{"type":"Feature","properties":{"name":"BB"},"geometry":{"type":"Polygon","coordinates":[[[-2.42,53.8],[-2.33,53.84],[-2.28,53.84],[-2.27,53.79],[-2.33,53.75],[-2.41,53.75],[-2.42,53.8]]]}},{"type":"Feature","properties":{"name":"BD"},"geometry":{"type":"Polygon","coordinates":[[[-1.88,53.9],[-1.76,53.92],[-1.76,53.86],[-1.86,53.82],[-1.94,53.83],[-1.94,53.88],[-1.88,53.9]]]}},{"type":"Feature","properties":{"name":"BH"},"geometry":{"type":"Polygon","coordinates":[[[-1.9,50.72],[-1.87,50.72],[-1.85,50.74],[-1.87,50.77],[-1.94,50.78],[-2.0,50.75],[-1.99,50.72],[-1.9,50.72]]]}},{"type":"Feature","properties":{"name":"BL"},"geometry":{"type":"Polygon","coordinates":[[[-2.41,53.58],[-2.34,53.58],[-2.35,53.62],[-2.43,53.62],[-2.41,53.58]]]}},{"type":"Feature","properties":{"name":"BN"},"geometry":{"type":"Polygon","coordinates":[[[-0.15,50.83],[-0.1,50.83],[-0.11,50.86],[-0.16,50.86],[-0.15,50.83]]]}},{"type":"Feature","properties":{"name":"BR"},"geometry":{"type":"Polygon","coordinates":[[[0.02,51.4],[0.05,51.4],[0.05,51.38],[0.02,51.37],[0.02,51.4]]]}},{"type":"Feature","properties":{"name":"BS"},"geometry":{"type":"Polygon","coordinates":[[[-2.59,51.45],[-2.55,51.46],[-2.54,51.48],[-2.57,51.5],[-2.62,51.48],[-2.62,51.46],[-2.59,51.45]]]}},{"type":"Feature","properties":{"name":"CA"},"geometry":{"type":"Polygon","coordinates":[[[-2.98,54.89],[-2.95,54.9],[-2.91,54.88],[-2.93,54.85],[-2.98,54.89]]]}},{"type":"Feature","properties":{"name":"CB"},"geometry":{"type":"Polygon","coordinates":[[[0.12,52.21],[0.16,52.21],[0.16,52.18],[0.12,52.18],[0.12,52.21]]]}},{"type":"Feature","properties":{"name":"CF"},"geometry":{"type":"Polygon","coordinates":[[[-3.18,51.48],[-3.16,51.49],[-3.17,51.52],[-3.21,51.51],[-3.2,51.47],[-3.18,51.48]]]}},{"type":"Feature","properties":{"name":"CH"},"geometry":{"type":"Polygon","coordinates":[[[-2.89,53.19],[-2.88,53.2],[-2.9,53.23],[-2.93,53.21],[-2.91,53.18],[-2.89,53.19]]]}},{"type":"Feature","properties":{"name":"CM"},"geometry":{"type":"Polygon","coordinates":[[[0.47,51.73],[0.5,51.74],[0.5,51.71],[0.46,51.71],[0.47,51.73]]]}},{"type":"Feature","properties":{"name":"CO"},"geometry":{"type":"Polygon","coordinates":[[[0.9,51.89],[0.93,51.89],[0.93,51.86],[0.89,51.87],[0.9,51.89]]]}},{"type":"Feature","properties":{"name":"CR"},"geometry":{"type":"Polygon","coordinates":[[[-0.1,51.37],[-0.07,51.38],[-0.08,51.34],[-0.12,51.35],[-0.1,51.37]]]}},{"type":"Feature","properties":{"name":"CT"},"geometry":{"type":"Polygon","coordinates":[[[1.08,51.28],[1.12,51.28],[1.13,51.25],[1.07,51.25],[1.08,51.28]]]}},{"type":"Feature","properties":{"name":"CV"},"geometry":{"type":"Polygon","coordinates":[[[-1.52,52.41],[-1.48,52.41],[-1.48,52.38],[-1.53,52.38],[-1.52,52.41]]]}},{"type":"Feature","properties":{"name":"CW"},"geometry":{"type":"Polygon","coordinates":[[[-2.52,53.15],[-2.45,53.16],[-2.46,53.12],[-2.53,53.11],[-2.52,53.15]]]}},{"type":"Feature","properties":{"name":"DA"},"geometry":{"type":"Polygon","coordinates":[[[0.31,51.45],[0.34,51.45],[0.34,51.42],[0.3,51.43],[0.31,51.45]]]}},{"type":"Feature","properties":{"name":"DD"},"geometry":{"type":"Polygon","coordinates":[[[-2.97,56.46],[-2.93,56.47],[-2.94,56.45],[-2.98,56.45],[-2.97,56.46]]]}},{"type":"Feature","properties":{"name":"DE"},"geometry":{"type":"Polygon","coordinates":[[[-1.48,52.92],[-1.44,52.93],[-1.44,52.9],[-1.48,52.9],[-1.48,52.92]]]}},{"type":"Feature","properties":{"name":"DG"},"geometry":{"type":"Polygon","coordinates":[[[-3.61,55.07],[-3.57,55.07],[-3.58,55.04],[-3.62,55.05],[-3.61,55.07]]]}},{"type":"Feature","properties":{"name":"DH"},"geometry":{"type":"Polygon","coordinates":[[[-1.58,54.78],[-1.54,54.78],[-1.55,54.75],[-1.59,54.75],[-1.58,54.78]]]}},{"type":"Feature","properties":{"name":"DL"},"geometry":{"type":"Polygon","coordinates":[[[-1.55,54.53],[-1.51,54.53],[-1.52,54.5],[-1.56,54.51],[-1.55,54.53]]]}},{"type":"Feature","properties":{"name":"DN"},"geometry":{"type":"Polygon","coordinates":[[[-1.13,53.52],[-1.08,53.53],[-1.09,53.5],[-1.14,53.5],[-1.13,53.52]]]}},{"type":"Feature","properties":{"name":"DT"},"geometry":{"type":"Polygon","coordinates":[[[-2.44,50.71],[-2.4,50.72],[-2.41,50.69],[-2.45,50.69],[-2.44,50.71]]]}},{"type":"Feature","properties":{"name":"DY"},"geometry":{"type":"Polygon","coordinates":[[[-2.11,52.47],[-2.08,52.47],[-2.09,52.44],[-2.13,52.45],[-2.11,52.47]]]}},{"type":"Feature","properties":{"name":"E"},"geometry":{"type":"Polygon","coordinates":[[[0,51.52],[0.03,51.52],[0.02,51.5],[-0.01,51.51],[-0,51.52]]]}},{"type":"Feature","properties":{"name":"EC"},"geometry":{"type":"Polygon","coordinates":[[[-0.1,51.52],[-0.08,51.52],[-0.08,51.51],[-0.1,51.51],[-0.1,51.52]]]}},{"type":"Feature","properties":{"name":"EH"},"geometry":{"type":"Polygon","coordinates":[[[-3.2,55.95],[-3.16,55.95],[-3.17,55.92],[-3.21,55.93],[-3.2,55.95]]]}},{"type":"Feature","properties":{"name":"EN"},"geometry":{"type":"Polygon","coordinates":[[[-0.08,51.65],[-0.05,51.66],[-0.05,51.63],[-0.09,51.63],[-0.08,51.65]]]}},{"type":"Feature","properties":{"name":"EX"},"geometry":{"type":"Polygon","coordinates":[[[-3.53,50.72],[-3.49,50.72],[-3.5,50.69],[-3.54,50.7],[-3.53,50.72]]]}},{"type":"Feature","properties":{"name":"FK"},"geometry":{"type":"Polygon","coordinates":[[[-3.78,56.02],[-3.74,56.02],[-3.75,55.99],[-3.79,56],[-3.78,56.02]]]}},{"type":"Feature","properties":{"name":"FY"},"geometry":{"type":"Polygon","coordinates":[[[-3.05,53.82],[-3.01,53.82],[-3.02,53.79],[-3.06,53.8],[-3.05,53.82]]]}},{"type":"Feature","properties":{"name":"G"},"geometry":{"type":"Polygon","coordinates":[[[-4.25,55.86],[-4.21,55.87],[-4.22,55.84],[-4.26,55.84],[-4.25,55.86]]]}},{"type":"Feature","properties":{"name":"GL"},"geometry":{"type":"Polygon","coordinates":[[[-2.22,51.87],[-2.18,51.87],[-2.19,51.84],[-2.23,51.85],[-2.22,51.87]]]}},{"type":"Feature","properties":{"name":"GU"},"geometry":{"type":"Polygon","coordinates":[[[-0.57,51.24],[-0.53,51.24],[-0.54,51.21],[-0.58,51.22],[-0.57,51.24]]]}},{"type":"Feature","properties":{"name":"HA"},"geometry":{"type":"Polygon","coordinates":[[[-0.33,51.58],[-0.3,51.58],[-0.31,51.55],[-0.34,51.56],[-0.33,51.58]]]}},{"type":"Feature","properties":{"name":"HD"},"geometry":{"type":"Polygon","coordinates":[[[-1.78,53.65],[-1.74,53.65],[-1.75,53.62],[-1.79,53.62],[-1.78,53.65]]]}},{"type":"Feature","properties":{"name":"HG"},"geometry":{"type":"Polygon","coordinates":[[[-1.51,53.99],[-1.47,54],[-1.48,53.97],[-1.52,53.97],[-1.51,53.99]]]}},{"type":"Feature","properties":{"name":"HP"},"geometry":{"type":"Polygon","coordinates":[[[-0.79,51.81],[-0.75,51.81],[-0.76,51.78],[-0.8,51.79],[-0.79,51.81]]]}},{"type":"Feature","properties":{"name":"HR"},"geometry":{"type":"Polygon","coordinates":[[[-2.72,52.06],[-2.68,52.06],[-2.69,52.03],[-2.73,52.04],[-2.72,52.06]]]}},{"type":"Feature","properties":{"name":"HS"},"geometry":{"type":"Polygon","coordinates":[[[-6.38,58.21],[-6.34,58.21],[-6.35,58.18],[-6.39,58.19],[-6.38,58.21]]]}},{"type":"Feature","properties":{"name":"HU"},"geometry":{"type":"Polygon","coordinates":[[[-0.34,53.74],[-0.3,53.75],[-0.31,53.72],[-0.35,53.72],[-0.34,53.74]]]}},{"type":"Feature","properties":{"name":"HX"},"geometry":{"type":"Polygon","coordinates":[[[-1.86,53.72],[-1.82,53.73],[-1.83,53.7],[-1.87,53.7],[-1.86,53.72]]]}},{"type":"Feature","properties":{"name":"IG"},"geometry":{"type":"Polygon","coordinates":[[[0.08,51.58],[0.11,51.58],[0.1,51.55],[0.07,51.56],[0.08,51.58]]]}},{"type":"Feature","properties":{"name":"IP"},"geometry":{"type":"Polygon","coordinates":[[[1.15,52.06],[1.19,52.06],[1.18,52.03],[1.14,52.04],[1.15,52.06]]]}},{"type":"Feature","properties":{"name":"IV"},"geometry":{"type":"Polygon","coordinates":[[[-4.22,57.48],[-4.18,57.48],[-4.19,57.45],[-4.23,57.46],[-4.22,57.48]]]}},{"type":"Feature","properties":{"name":"KA"},"geometry":{"type":"Polygon","coordinates":[[[-4.56,55.61],[-4.52,55.61],[-4.53,55.58],[-4.57,55.59],[-4.56,55.61]]]}},{"type":"Feature","properties":{"name":"KT"},"geometry":{"type":"Polygon","coordinates":[[[-0.31,51.41],[-0.28,51.41],[-0.29,51.38],[-0.32,51.39],[-0.31,51.41]]]}},{"type":"Feature","properties":{"name":"KW"},"geometry":{"type":"Polygon","coordinates":[[[-3.09,58.98],[-3.05,58.98],[-3.06,58.95],[-3.1,58.96],[-3.09,58.98]]]}},{"type":"Feature","properties":{"name":"KY"},"geometry":{"type":"Polygon","coordinates":[[[-3.22,56.21],[-3.18,56.21],[-3.19,56.18],[-3.23,56.19],[-3.22,56.21]]]}},{"type":"Feature","properties":{"name":"L"},"geometry":{"type":"Polygon","coordinates":[[[-2.98,53.41],[-2.94,53.41],[-2.95,53.38],[-2.99,53.39],[-2.98,53.41]]]}},{"type":"Feature","properties":{"name":"LA"},"geometry":{"type":"Polygon","coordinates":[[[-2.77,54.05],[-2.73,54.05],[-2.74,54.02],[-2.78,54.03],[-2.77,54.05]]]}},{"type":"Feature","properties":{"name":"LD"},"geometry":{"type":"Polygon","coordinates":[[[-3.44,52.13],[-3.4,52.13],[-3.41,52.1],[-3.45,52.11],[-3.44,52.13]]]}},{"type":"Feature","properties":{"name":"LE"},"geometry":{"type":"Polygon","coordinates":[[[-1.13,52.63],[-1.09,52.64],[-1.1,52.61],[-1.14,52.61],[-1.13,52.63]]]}},{"type":"Feature","properties":{"name":"LL"},"geometry":{"type":"Polygon","coordinates":[[[-3.83,53.28],[-3.79,53.28],[-3.8,53.25],[-3.84,53.26],[-3.83,53.28]]]}},{"type":"Feature","properties":{"name":"LN"},"geometry":{"type":"Polygon","coordinates":[[[-0.54,53.23],[-0.5,53.24],[-0.51,53.21],[-0.55,53.21],[-0.54,53.23]]]}},{"type":"Feature","properties":{"name":"LS"},"geometry":{"type":"Polygon","coordinates":[[[-1.55,53.8],[-1.51,53.8],[-1.52,53.77],[-1.56,53.78],[-1.55,53.8]]]}},{"type":"Feature","properties":{"name":"LU"},"geometry":{"type":"Polygon","coordinates":[[[-0.42,51.88],[-0.38,51.88],[-0.39,51.85],[-0.43,51.86],[-0.42,51.88]]]}},{"type":"Feature","properties":{"name":"M"},"geometry":{"type":"Polygon","coordinates":[[[-2.24,53.48],[-2.2,53.48],[-2.21,53.45],[-2.25,53.46],[-2.24,53.48]]]}},{"type":"Feature","properties":{"name":"ME"},"geometry":{"type":"Polygon","coordinates":[[[0.52,51.38],[0.56,51.38],[0.55,51.35],[0.51,51.36],[0.52,51.38]]]}},{"type":"Feature","properties":{"name":"MK"},"geometry":{"type":"Polygon","coordinates":[[[-0.77,52.04],[-0.73,52.04],[-0.74,52.01],[-0.78,52.02],[-0.77,52.04]]]}},{"type":"Feature","properties":{"name":"ML"},"geometry":{"type":"Polygon","coordinates":[[[-3.98,55.78],[-3.94,55.78],[-3.95,55.75],[-3.99,55.76],[-3.98,55.78]]]}},{"type":"Feature","properties":{"name":"N"},"geometry":{"type":"Polygon","coordinates":[[[-0.1,51.54],[-0.07,51.55],[-0.08,51.52],[-0.11,51.52],[-0.1,51.54]]]}},{"type":"Feature","properties":{"name":"NE"},"geometry":{"type":"Polygon","coordinates":[[[-1.62,54.98],[-1.58,54.98],[-1.59,54.95],[-1.63,54.96],[-1.62,54.98]]]}},{"type":"Feature","properties":{"name":"NG"},"geometry":{"type":"Polygon","coordinates":[[[-1.15,52.95],[-1.11,52.96],[-1.12,52.93],[-1.16,52.93],[-1.15,52.95]]]}},{"type":"Feature","properties":{"name":"NN"},"geometry":{"type":"Polygon","coordinates":[[[-0.9,52.24],[-0.86,52.24],[-0.87,52.21],[-0.91,52.22],[-0.9,52.24]]]}},{"type":"Feature","properties":{"name":"NP"},"geometry":{"type":"Polygon","coordinates":[[[-2.99,51.59],[-2.95,51.59],[-2.96,51.56],[-3,51.57],[-2.99,51.59]]]}},{"type":"Feature","properties":{"name":"NR"},"geometry":{"type":"Polygon","coordinates":[[[1.29,52.63],[1.33,52.63],[1.32,52.6],[1.28,52.61],[1.29,52.63]]]}},{"type":"Feature","properties":{"name":"NW"},"geometry":{"type":"Polygon","coordinates":[[[-0.17,51.54],[-0.14,51.54],[-0.15,51.51],[-0.18,51.52],[-0.17,51.54]]]}},{"type":"Feature","properties":{"name":"OL"},"geometry":{"type":"Polygon","coordinates":[[[-2.11,53.54],[-2.07,53.54],[-2.08,53.51],[-2.12,53.52],[-2.11,53.54]]]}},{"type":"Feature","properties":{"name":"OX"},"geometry":{"type":"Polygon","coordinates":[[[-1.26,51.75],[-1.22,51.76],[-1.23,51.73],[-1.27,51.73],[-1.26,51.75]]]}},{"type":"Feature","properties":{"name":"PA"},"geometry":{"type":"Polygon","coordinates":[[[-4.42,55.84],[-4.38,55.85],[-4.39,55.82],[-4.43,55.82],[-4.42,55.84]]]}},{"type":"Feature","properties":{"name":"PE"},"geometry":{"type":"Polygon","coordinates":[[[-0.24,52.58],[-0.2,52.58],[-0.21,52.55],[-0.25,52.56],[-0.24,52.58]]]}},{"type":"Feature","properties":{"name":"PH"},"geometry":{"type":"Polygon","coordinates":[[[-3.43,56.4],[-3.39,56.4],[-3.4,56.37],[-3.44,56.38],[-3.43,56.4]]]}},{"type":"Feature","properties":{"name":"PL"},"geometry":{"type":"Polygon","coordinates":[[[-4.14,50.37],[-4.1,50.38],[-4.11,50.35],[-4.15,50.35],[-4.14,50.37]]]}},{"type":"Feature","properties":{"name":"PO"},"geometry":{"type":"Polygon","coordinates":[[[-1.09,50.8],[-1.05,50.8],[-1.06,50.77],[-1.1,50.78],[-1.09,50.8]]]}},{"type":"Feature","properties":{"name":"PR"},"geometry":{"type":"Polygon","coordinates":[[[-2.77,53.76],[-2.73,53.76],[-2.74,53.73],[-2.78,53.74],[-2.77,53.76]]]}},{"type":"Feature","properties":{"name":"RG"},"geometry":{"type":"Polygon","coordinates":[[[-0.97,51.45],[-0.93,51.46],[-0.94,51.43],[-0.98,51.43],[-0.97,51.45]]]}},{"type":"Feature","properties":{"name":"RH"},"geometry":{"type":"Polygon","coordinates":[[[-0.19,51.24],[-0.15,51.24],[-0.16,51.21],[-0.2,51.22],[-0.19,51.24]]]}},{"type":"Feature","properties":{"name":"RM"},"geometry":{"type":"Polygon","coordinates":[[[0.18,51.58],[0.21,51.58],[0.2,51.55],[0.17,51.56],[0.18,51.58]]]}},{"type":"Feature","properties":{"name":"S"},"geometry":{"type":"Polygon","coordinates":[[[-1.47,53.38],[-1.43,53.38],[-1.44,53.35],[-1.48,53.36],[-1.47,53.38]]]}},{"type":"Feature","properties":{"name":"SA"},"geometry":{"type":"Polygon","coordinates":[[[-3.94,51.62],[-3.9,51.62],[-3.91,51.59],[-3.95,51.6],[-3.94,51.62]]]}},{"type":"Feature","properties":{"name":"SE"},"geometry":{"type":"Polygon","coordinates":[[[0,51.5],[0.03,51.5],[-0.01,51.47],[-0.04,51.48],[0,51.5]]]}},{"type":"Feature","properties":{"name":"SG"},"geometry":{"type":"Polygon","coordinates":[[[-0.19,51.99],[-0.15,51.99],[-0.16,51.96],[-0.2,51.97],[-0.19,51.99]]]}},{"type":"Feature","properties":{"name":"SK"},"geometry":{"type":"Polygon","coordinates":[[[-2.16,53.41],[-2.12,53.41],[-2.13,53.38],[-2.17,53.39],[-2.16,53.41]]]}},{"type":"Feature","properties":{"name":"SL"},"geometry":{"type":"Polygon","coordinates":[[[-0.6,51.51],[-0.56,51.51],[-0.57,51.48],[-0.61,51.49],[-0.6,51.51]]]}},{"type":"Feature","properties":{"name":"SM"},"geometry":{"type":"Polygon","coordinates":[[[-0.19,51.36],[-0.16,51.36],[-0.17,51.33],[-0.2,51.34],[-0.19,51.36]]]}},{"type":"Feature","properties":{"name":"SN"},"geometry":{"type":"Polygon","coordinates":[[[-1.78,51.56],[-1.74,51.57],[-1.75,51.54],[-1.79,51.54],[-1.78,51.56]]]}},{"type":"Feature","properties":{"name":"SO"},"geometry":{"type":"Polygon","coordinates":[[[-1.4,50.91],[-1.36,50.91],[-1.37,50.88],[-1.41,50.89],[-1.4,50.91]]]}},{"type":"Feature","properties":{"name":"SP"},"geometry":{"type":"Polygon","coordinates":[[[-1.8,51.07],[-1.76,51.07],[-1.77,51.04],[-1.81,51.05],[-1.8,51.07]]]}},{"type":"Feature","properties":{"name":"SR"},"geometry":{"type":"Polygon","coordinates":[[[-1.38,54.91],[-1.34,54.91],[-1.35,54.88],[-1.39,54.89],[-1.38,54.91]]]}},{"type":"Feature","properties":{"name":"SS"},"geometry":{"type":"Polygon","coordinates":[[[0.71,51.54],[0.75,51.54],[0.74,51.51],[0.7,51.52],[0.71,51.54]]]}},{"type":"Feature","properties":{"name":"ST"},"geometry":{"type":"Polygon","coordinates":[[[-2.18,53],[-2.14,53],[-2.15,52.97],[-2.19,52.98],[-2.18,53]]]}},{"type":"Feature","properties":{"name":"SW"},"geometry":{"type":"Polygon","coordinates":[[[-0.15,51.48],[-0.12,51.49],[-0.13,51.46],[-0.16,51.46],[-0.15,51.48]]]}},{"type":"Feature","properties":{"name":"SY"},"geometry":{"type":"Polygon","coordinates":[[[-2.75,52.71],[-2.71,52.71],[-2.72,52.68],[-2.76,52.69],[-2.75,52.71]]]}},{"type":"Feature","properties":{"name":"TA"},"geometry":{"type":"Polygon","coordinates":[[[-3.1,51.01],[-3.06,51.02],[-3.07,50.99],[-3.11,50.99],[-3.1,51.01]]]}},{"type":"Feature","properties":{"name":"TD"},"geometry":{"type":"Polygon","coordinates":[[[-2.52,55.76],[-2.48,55.76],[-2.49,55.73],[-2.53,55.74],[-2.52,55.76]]]}},{"type":"Feature","properties":{"name":"TF"},"geometry":{"type":"Polygon","coordinates":[[[-2.44,52.68],[-2.4,52.68],[-2.41,52.65],[-2.45,52.66],[-2.44,52.68]]]}},{"type":"Feature","properties":{"name":"TN"},"geometry":{"type":"Polygon","coordinates":[[[0.51,51.13],[0.55,51.13],[0.54,51.1],[0.5,51.11],[0.51,51.13]]]}},{"type":"Feature","properties":{"name":"TQ"},"geometry":{"type":"Polygon","coordinates":[[[-3.58,50.46],[-3.54,50.46],[-3.55,50.43],[-3.59,50.44],[-3.58,50.46]]]}},{"type":"Feature","properties":{"name":"TR"},"geometry":{"type":"Polygon","coordinates":[[[-5.21,50.26],[-5.17,50.27],[-5.18,50.24],[-5.22,50.24],[-5.21,50.26]]]}},{"type":"Feature","properties":{"name":"TS"},"geometry":{"type":"Polygon","coordinates":[[[-1.23,54.57],[-1.19,54.58],[-1.2,54.55],[-1.24,54.55],[-1.23,54.57]]]}},{"type":"Feature","properties":{"name":"TW"},"geometry":{"type":"Polygon","coordinates":[[[-0.37,51.45],[-0.34,51.45],[-0.35,51.42],[-0.38,51.43],[-0.37,51.45]]]}},{"type":"Feature","properties":{"name":"UB"},"geometry":{"type":"Polygon","coordinates":[[[-0.4,51.51],[-0.37,51.51],[-0.38,51.48],[-0.41,51.49],[-0.4,51.51]]]}},{"type":"Feature","properties":{"name":"W"},"geometry":{"type":"Polygon","coordinates":[[[-0.2,51.51],[-0.17,51.52],[-0.18,51.49],[-0.21,51.49],[-0.2,51.51]]]}},{"type":"Feature","properties":{"name":"WA"},"geometry":{"type":"Polygon","coordinates":[[[-2.6,53.39],[-2.56,53.39],[-2.57,53.36],[-2.61,53.37],[-2.6,53.39]]]}},{"type":"Feature","properties":{"name":"WC"},"geometry":{"type":"Polygon","coordinates":[[[-0.12,51.52],[-0.1,51.52],[-0.11,51.51],[-0.13,51.51],[-0.12,51.52]]]}},{"type":"Feature","properties":{"name":"WD"},"geometry":{"type":"Polygon","coordinates":[[[-0.41,51.65],[-0.38,51.65],[-0.39,51.62],[-0.42,51.63],[-0.41,51.65]]]}},{"type":"Feature","properties":{"name":"WF"},"geometry":{"type":"Polygon","coordinates":[[[-1.5,53.68],[-1.46,53.68],[-1.47,53.65],[-1.51,53.66],[-1.5,53.68]]]}},{"type":"Feature","properties":{"name":"WN"},"geometry":{"type":"Polygon","coordinates":[[[-2.63,53.54],[-2.59,53.54],[-2.6,53.51],[-2.64,53.52],[-2.63,53.54]]]}},{"type":"Feature","properties":{"name":"WR"},"geometry":{"type":"Polygon","coordinates":[[[-2.22,52.19],[-2.18,52.2],[-2.19,52.17],[-2.23,52.17],[-2.22,52.19]]]}},{"type":"Feature","properties":{"name":"WS"},"geometry":{"type":"Polygon","coordinates":[[[-1.98,52.58],[-1.94,52.59],[-1.95,52.56],[-1.99,52.56],[-1.98,52.58]]]}},{"type":"Feature","properties":{"name":"WV"},"geometry":{"type":"Polygon","coordinates":[[[-2.12,52.59],[-2.08,52.59],[-2.09,52.56],[-2.13,52.57],[-2.12,52.59]]]}},{"type":"Feature","properties":{"name":"YO"},"geometry":{"type":"Polygon","coordinates":[[[-1.08,53.96],[-1.04,53.96],[-1.05,53.93],[-1.09,53.94],[-1.08,53.96]]]}},{"type":"Feature","properties":{"name":"ZE"},"geometry":{"type":"Polygon","coordinates":[[[-1.16,60.15],[-1.12,60.16],[-1.13,60.13],[-1.17,60.13],[-1.16,60.15]]]}}]};

        // --- Main Application Logic --- //

        function initializeMap() {
            try {
                processServiceData();
                geoJsonLayer = L.geoJSON(geoJsonData, {
                    style: styleFeature,
                    onEachFeature: onEachFeature
                }).addTo(map);
                
                setupEventListeners();
                addLegend();
            } catch (error) {
                console.error("Map Initialization Error:", error);
            }
        }
        
        function simpleCsvParse(csvString) { /* ... same as before ... */ }
        function processServiceData() { /* ... same as before ... */ }
        function styleFeature(feature) { /* ... same as before ... */ }
        
        function onEachFeature(feature, layer) {
            const areaCode = feature.properties.name;
            layer.bindPopup(generatePopupContent(areaCode));
            layer.on({
                mouseover: e => e.target.setStyle({ weight: 4, color: '#333', dashArray: '' }),
                mouseout: e => geoJsonLayer.resetStyle(e.target),
                click: e => openEditPanel(areaCode, layer)
            });
        }

        function generatePopupContent(areaCode) {
            const data = serviceDataByArea.get(areaCode) || { hasSolar: false, hasHeatPump: false, hasEv: false };
            let content = `<b>Postcode Area: ${areaCode}</b><br><hr>Services Available:`;
            if (!data.hasSolar && !data.hasHeatPump && !data.hasEv) content += '<br>None';
            if (data.hasSolar) content += `<br>✔️ Solar Panels`;
            if (data.hasHeatPump) content += `<br>✔️ Heat Pumps`;
            if (data.hasEv) content += `<br>✔️ EV Chargers`;
            content += `<br><br><i>Click to edit services for this area.</i>`;
            return content;
        }

        function openEditPanel(areaCode, layer) {
            currentlyEditingArea = { code: areaCode, layer: layer };
            const data = serviceDataByArea.get(areaCode) || { hasSolar: false, hasHeatPump: false, hasEv: false };
            
            document.getElementById('edit-panel-title').innerText = `Edit Services for ${areaCode}`;
            document.querySelector('#edit-panel-toggles [data-service="hasSolar"]').checked = data.hasSolar;
            document.querySelector('#edit-panel-toggles [data-service="hasHeatPump"]').checked = data.hasHeatPump;
            document.querySelector('#edit-panel-toggles [data-service="hasEv"]').checked = data.hasEv;
            
            editPanel.classList.add('visible');
        }

        function closeEditPanel() {
            editPanel.classList.remove('visible');
            currentlyEditingArea = null;
        }

        function handleServiceEdit(e) {
            if (!currentlyEditingArea) return;
            
            const service = e.target.dataset.service;
            const isEnabled = e.target.checked;
            const areaCode = currentlyEditingArea.code;

            // Ensure the area exists in our data map before editing
            if (!serviceDataByArea.has(areaCode)) {
                serviceDataByArea.set(areaCode, { hasSolar: false, hasHeatPump: false, hasEv: false });
            }
            
            const data = serviceDataByArea.get(areaCode);
            data[service] = isEnabled;
            
            // Re-style the specific layer that was changed and update its popup
            currentlyEditingArea.layer.setStyle(styleFeature(currentlyEditingArea.layer.feature));
            currentlyEditingArea.layer.setPopupContent(generatePopupContent(areaCode));
        }

        function generateAndDownloadCsv() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Area,Solar Panels,Heat Pumps,Ev Chargers\r\n";
            
            serviceDataByArea.forEach((services, area) => {
                const row = [
                    area,
                    services.hasSolar ? '1' : '0',
                    services.hasHeatPump ? '1' : '0',
                    services.hasEv ? '1' : '0'
                ].join(',');
                csvContent += row + "\r\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "updated_service_coverage.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function setupEventListeners() {
            // Main filter checkboxes
            document.querySelectorAll('#filter-controls input').forEach(cb => cb.addEventListener('change', () => geoJsonLayer.setStyle(styleFeature)));
            // Edit panel controls
            document.getElementById('close-edit-panel').addEventListener('click', closeEditPanel);
            document.querySelectorAll('#edit-panel-toggles input').forEach(cb => cb.addEventListener('change', handleServiceEdit));
            // Download button
            document.getElementById('download-btn').addEventListener('click', generateAndDownloadCsv);
        }
        
        function addLegend() { /* ... same as before ... */ }

        // --- Run the application --- //
        initializeMap();
    </script>
</body>
</html>
