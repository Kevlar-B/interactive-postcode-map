<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Coverage Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        header { padding: 10px 20px; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        h1 { margin: 0; font-size: 1.5em; display: inline-block; vertical-align: middle; }
        #status { padding: 5px 20px 10px; font-style: italic; color: #6c757d; }
        #map { flex-grow: 1; width: 100%; background-color: #e9ecef; }

        /* Styles for the new filter controls */
        #filter-controls {
            display: flex;
            gap: 20px;
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }
        #filter-controls label {
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        #filter-controls input {
            margin-right: 8px;
        }
    </style>
</head>
<body>

    <header>
        <h1>Service Launch Coverage</h1>
    </header>

    <div id="filter-controls">
        <strong>Filter by service:</strong>
        <label><input type="checkbox" id="solar-filter" checked> üü° Solar Panels</label>
        <label><input type="checkbox" id="heatpump-filter" checked> üîµ Heat Pumps</label>
        <label><input type="checkbox" id="ev-filter" checked> üü¢ EV Chargers</label>
    </div>
    
    <div id="status">Initializing map...</div>
    
    <div id="map"></div>

    <script>
        // --- Global Variables --- //
        let allMapMarkers = []; // Will store all our marker objects
        const map = L.map('map').setView([54.5, -3.4], 6);
        const statusElement = document.getElementById('status');
        
        // --- Map Initialization --- //
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- Custom Marker Icons --- //
        // Create different colored icons for visual distinction
        const createColoredIcon = (color) => new L.Icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        const goldIcon = createColoredIcon('gold');
        const blueIcon = createColoredIcon('blue');
        const greenIcon = createColoredIcon('green');
        const violetIcon = createColoredIcon('violet'); // Default for multiple services

        // --- Embedded CSV Data --- //
        const csvData = `
Region,Solar Panels,Heat Pumps,Ev Chargers
BD1,0,1,1
BD2,0,1,1
BD3,0,1,1
BD4,0,1,1
BD5,0,1,1
BD6,0,1,1
BD7,0,1,1
BD8,0,1,1
BD9,0,1,1
BD10,0,1,1
BD11,0,1,1
BD12,0,1,1
BD13,0,1,1
BD14,0,1,1
BD15,0,1,1
BD16,0,1,1
BD17,0,1,1
BD18,0,1,1
BD19,0,1,1
BD20,0,1,1
BD21,0,1,1
BD22,0,1,1
BD23,0,1,1
BD24,0,1,1
BD97,0,1,1
BD98,0,1,1
BD99,0,1,1
HG1,0,1,1
HG2,0,1,1
HG3,0,1,1
HG4,0,1,1
HG5,0,1,1
PR0,0,1,1
PR1,0,1,1
PR2,0,1,1
PR3,0,1,1
PR4,0,1,1
PR5,0,1,1
PR6,0,1,1
PR7,0,1,1
PR8,0,1,1
PR9,0,1,1
PR11,0,1,1
PR25,0,1,1
PR26,0,1,1
BB0,0,1,1
BB1,0,1,1
BB2,0,1,1
BB3,0,1,1
BB4,0,1,1
BB5,0,1,1
BB6,0,1,1
BB7,0,1,1
BB8,0,1,1
BB9,0,1,1
BB10,0,1,1
BB11,0,1,1
BB12,0,1,1
BB18,0,1,1
BB94,0,1,1
L1,0,1,1
L2,0,1,1
L3,0,1,1
L4,0,1,1
L5,0,1,1
L6,0,1,1
L7,0,1,1
L8,0,1,1
L9,0,1,1
L10,0,1,1
L11,0,1,1
L12,0,1,1
L13,0,1,1
L14,0,1,1
L15,0,1,1
L16,0,1,1
L17,0,1,1
L18,0,1,1
L19,0,1,1
L20,0,1,1
L21,0,1,1
L22,0,1,1
L23,0,1,1
L24,0,1,1
L25,0,1,1
L26,0,1,1
L27,0,1,1
L28,0,1,1
L29,0,1,1
L30,0,1,1
L31,0,1,1
L32,0,1,1
L33,0,1,1
L34,0,1,1
L35,0,1,1
L36,0,1,1
L37,0,1,1
L38,0,1,1
L39,0,1,1
L40,0,1,1
L67,0,1,1
L68,0,1,1
L69,0,1,1
L70,0,1,1
L71,0,1,1
L72,0,1,1
L73,0,1,1
L74,0,1,1
L75,0,1,1
L80,0,1,1
WN1,0,1,1
WN2,0,1,1
WN3,0,1,1
WN4,0,1,1
WN5,0,1,1
WN6,0,1,1
WN7,0,1,1
WN8,0,1,1
BL0,0,1,1
BL1,0,1,1
BL2,0,1,1
BL3,0,1,1
BL4,0,1,1
BL5,0,1,1
BL6,0,1,1
BL7,0,1,1
BL8,0,1,1
BL9,0,1,1
OL1,0,1,1
OL2,0,1,1
OL3,0,1,1
OL4,0,1,1
OL5,0,1,1
OL6,0,1,1
OL7,0,1,1
OL8,0,1,1
OL9,0,1,1
OL10,0,1,1
OL11,0,1,1
OL12,0,1,1
OL13,0,1,1
OL14,0,1,1
OL15,0,1,1
OL16,0,1,1
OL95,0,1,1
HX1,0,1,1
HX2,0,1,1
HX3,0,1,1
HX4,0,1,1
HX5,0,1,1
HX6,0,1,1
HX7,0,1,1
HD1,0,1,1
HD2,0,1,1
HD3,0,1,1
HD4,0,1,1
HD5,0,1,1
HD6,0,1,1
HD7,0,1,1
HD8,0,1,1
HD9,0,1,1
WF1,0,1,1
WF2,0,1,1
WF3,0,1,1
WF4,0,1,1
WF5,0,1,1
WF6,0,1,1
WF7,0,1,1
WF8,0,1,1
WF9,0,1,1
WF10,0,1,1
WF11,0,1,1
WF12,0,1,1
WF13,0,1,1
WF14,0,1,1
WF15,0,1,1
WF16,0,1,1
WF17,0,1,1
WF90,0,1,1
DN1,0,1,1
DN2,0,1,1
DN3,0,1,1
DN4,0,1,1
DN5,0,1,1
DN6,0,1,1
DN7,0,1,1
DN8,0,1,1
DN9,0,1,1
DN10,0,1,1
DN11,0,1,1
DN12,0,1,1
DN14,0,1,1
DN15,0,1,1
DN16,0,1,1
DN17,0,1,1
DN18,0,1,1
DN19,0,1,1
DN20,0,1,1
DN21,0,1,1
DN22,0,1,1
DN31,0,1,1
DN32,0,1,1
DN33,0,1,1
DN34,0,1,1
DN35,0,1,1
DN36,0,1,1
DN37,0,1,1
DN38,0,1,1
DN39,0,1,1
DN40,0,1,1
DN41,0,1,1
DN55,0,1,1
CH1,0,1,1
CH2,0,1,1
CH3,0,1,1
CH4,0,1,1
CH5,0,1,1
CH6,0,1,1
CH7,0,1,1
CH8,0,1,1
CH25,0,1,1
CH26,0,1,1
CH27,0,1,1
CH28,0,1,1
CH29,0,1,1
CH30,0,1,1
CH31,0,1,1
CH32,0,1,1
CH33,0,1,1
CH34,0,1,1
CH41,0,1,1
CH42,0,1,1
CH43,0,1,1
CH44,0,1,1
CH45,0,1,1
CH46,0,1,1
CH47,0,1,1
CH48,0,1,1
CH49,0,1,1
CH60,0,1,1
CH61,0,1,1
CH62,0,1,1
CH63,0,1,1
CH64,0,1,1
CH65,0,1,1
CH66,0,1,1
CH88,0,1,1
CH99,0,1,1
CW1,0,1,1
CW2,0,1,1
CW3,0,1,1
CW4,0,1,1
CW5,0,1,1
CW6,0,1,1
CW7,0,1,1
CW8,0,1,1
CW9,0,1,1
CW10,0,1,1
CW11,0,1,1
CW12,0,1,1
CW98,0,1,1
WA1,0,1,1
WA2,0,1,1
WA3,0,1,1
WA4,0,1,1
WA5,0,1,1
WA6,0,1,1
WA7,0,1,1
WA8,0,1,1
WA9,0,1,1
WA10,0,1,1
WA11,0,1,1
WA12,0,1,1
WA13,0,1,1
WA14,0,1,1
WA15,0,1,1
WA16,0,1,1
WA55,0,1,1
WA88,0,1,1
M1,0,1,1
M2,0,1,1
M3,0,1,1
M4,0,1,1
M5,0,1,1
M6,0,1,1
M7,0,1,1
M8,0,1,1
M9,0,1,1
M11,0,1,1
M12,0,1,1
M13,0,1,1
M14,0,1,1
M15,0,1,1
M16,0,1,1
M17,0,1,1
M18,0,1,1
M19,0,1,1
M20,0,1,1
M21,0,1,1
M22,0,1,1
M23,0,1,1
M24,0,1,1
M25,0,1,1
M26,0,1,1
M27,0,1,1
M28,0,1,1
M29,0,1,1
M30,0,1,1
M31,0,1,1
M32,0,1,1
M33,0,1,1
M34,0,1,1
M35,0,1,1
M38,0,1,1
M40,0,1,1
M41,0,1,1
M43,0,1,1
M44,0,1,1
M45,0,1,1
M46,0,1,1
M50,0,1,1
M60,0,1,1
M61,0,1,1
M90,0,1,1
M99,0,1,1
SK1,0,1,1
SK2,0,1,1
SK3,0,1,1
SK4,0,1,1
SK5,0,1,1
SK6,0,1,1
SK7,0,1,1
SK8,0,1,1
SK9,0,1,1
SK10,0,1,1
SK11,0,1,1
SK12,0,1,1
SK13,0,1,1
SK14,0,1,1
SK15,0,1,1
SK16,0,1,1
SK17,0,1,1
SK22,0,1,1
SK23,0,1,1
S1,0,1,1
S2,0,1,1
S3,0,1,1
S4,0,1,1
S5,0,1,1
S6,0,1,1
S7,0,1,1
S8,0,1,1
S9,0,1,1
S10,0,1,1
S11,0,1,1
S12,0,1,1
S13,0,1,1
S14,0,1,1
S17,0,1,1
S18,0,1,1
S19,0,1,1
S20,0,1,1
S21,0,1,1
S25,0,1,1
S26,0,1,1
S30,0,1,1
S31,0,1,1
S32,0,1,1
S33,0,1,1
S35,0,1,1
S36,0,1,1
S40,0,1,1
S41,0,1,1
S42,0,1,1
S43,0,1,1
S44,0,1,1
S45,0,1,1
S49,0,1,1
S60,0,1,1
S61,0,1,1
S62,0,1,1
S63,0,1,1
S64,0,1,1
S65,0,1,1
S66,0,1,1
S70,0,1,1
S71,0,1,1
S72,0,1,1
S73,0,1,1
S74,0,1,1
S75,0,1,1
S80,0,1,1
S81,0,1,1
S94,0,1,1
S95,0,1,1
S96,0,1,1
S97,0,1,1
S98,0,1,1
S99,0,1,1
DE1,0,1,1
DE3,0,1,1
DE4,0,1,1
DE5,0,1,1
DE6,0,1,1
DE7,0,1,1
DE11,0,1,1
DE12,0,1,1
DE13,0,1,1
DE14,0,1,1
DE15,0,1,1
DE21,0,1,1
DE22,0,1,1
DE23,0,1,1
DE24,0,1,1
DE45,0,1,1
DE55,0,1,1
DE56,0,1,1
DE65,0,1,1
DE72,0,1,1
DE73,0,1,1
DE74,0,1,1
DE75,0,1,1
DE99,0,1,1
NG1,0,1,1
NG2,0,1,1
NG3,0,1,1
NG4,0,1,1
NG5,0,1,1
NG6,0,1,1
NG7,0,1,1
NG8,0,1,1
NG9,0,1,1
NG10,0,1,1
NG11,0,1,1
NG12,0,1,1
NG13,0,1,1
NG14,0,1,1
NG15,0,1,1
NG16,0,1,1
NG17,0,1,1
NG18,0,1,1
NG19,0,1,1
NG20,0,1,1
NG21,0,1,1
NG22,0,1,1
NG23,0,1,1
NG24,0,1,1
NG25,0,1,1
NG31,0,1,1
NG32,0,1,1
NG33,0,1,1
NG34,0,1,1
NG70,0,1,1
NG80,0,1,1
NG90,0,1,1
LS1,0,1,1
LS2,0,1,1
LS3,0,1,1
LS4,0,1,1
LS5,0,1,1
LS6,0,1,1
LS7,0,1,1
LS8,0,1,1
LS9,0,1,1
LS10,0,1,1
LS11,0,1,1
LS12,0,1,1
LS13,0,1,1
LS14,0,1,1
LS15,0,1,1
LS16,0,1,1
LS17,0,1,1
LS18,0,1,1
LS19,0,1,1
LS20,0,1,1
LS21,0,1,1
LS22,0,1,1
LS23,0,1,1
LS24,0,1,1
LS25,0,1,1
LS26,0,1,1
LS27,0,1,1
LS28,0,1,1
LS29,0,1,1
FY0,0,1,1
FY1,0,1,1
FY2,0,1,1
FY3,0,1,1
FY4,0,1,1
FY5,0,1,1
FY6,0,1,1
FY7,0,1,1
FY8,0,1,1
OX7,1,0,0
OX9,1,0,0
`;

        /**
         * Main function to fetch, process, and plot all data.
         */
        async function initializeMap() {
            try {
                // 1. Parse Data
                statusElement.textContent = 'Parsing coverage data...';
                const parsedData = Papa.parse(csvData.trim(), { header: true, skipEmptyLines: true }).data;
                const postcodes = parsedData.map(row => row.Region).filter(pc => pc);
                if (postcodes.length === 0) throw new Error("No postcodes found.");
                
                // 2. Fetch Coordinates
                statusElement.textContent = `Found ${postcodes.length} postcodes. Fetching coordinates...`;
                const allCoordinates = await fetchCoordinatesInBatches(postcodes);
                statusElement.textContent = `Found coordinates for ${allCoordinates.length} postcodes. Creating map...`;

                // 3. Create Markers
                const coverageDataMap = new Map(parsedData.map(row => [row.Region, row]));
                allCoordinates.forEach(data => {
                    const postcodeInfo = data.result;
                    const originalRow = coverageDataMap.get(postcodeInfo.postcode);
                    if (originalRow) {
                        const hasSolar = originalRow['Solar Panels'] === '1';
                        const hasHeatPump = originalRow['Heat Pumps'] === '1';
                        const hasEv = originalRow['Ev Chargers'] === '1';

                        let icon = violetIcon; // Default for multiple services
                        const serviceCount = (hasSolar ? 1:0) + (hasHeatPump ? 1:0) + (hasEv ? 1:0);
                        if (serviceCount === 1) {
                            if(hasSolar) icon = goldIcon;
                            if(hasHeatPump) icon = blueIcon;
                            if(hasEv) icon = greenIcon;
                        }

                        let popupContent = `<b>Postcode: ${originalRow.Region}</b><br><hr>`;
                        popupContent += `Solar Panels: ${hasSolar ? '‚úîÔ∏è Yes' : '‚ùå No'}<br>`;
                        popupContent += `Heat Pumps: ${hasHeatPump ? '‚úîÔ∏è Yes' : '‚ùå No'}<br>`;
                        popupContent += `EV Chargers: ${hasEv ? '‚úîÔ∏è Yes' : '‚ùå No'}`;
                        
                        const marker = L.marker([postcodeInfo.latitude, postcodeInfo.longitude], {
                            icon: icon,
                            // Store service data directly on the marker for filtering
                            hasSolar: hasSolar,
                            hasHeatPump: hasHeatPump,
                            hasEv: hasEv
                        }).bindPopup(popupContent);
                        
                        allMapMarkers.push(marker);
                    }
                });

                setupFilterListeners();
                updateMapVisibility(); // Initial draw
                statusElement.textContent = `Map ready. ${allMapMarkers.length} locations loaded.`;

            } catch (error) {
                console.error("Map Error:", error);
                statusElement.innerHTML = `<strong>Error:</strong> ${error.message}`;
                statusElement.style.color = 'red';
            }
        }

        async function fetchCoordinatesInBatches(postcodes) {
            let allCoords = [];
            for (let i = 0; i < postcodes.length; i += 100) {
                const batch = postcodes.slice(i, i + 100);
                const apiResponse = await fetch('https://api.postcodes.io/postcodes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ postcodes: batch })
                });
                const json = await apiResponse.json();
                if (json.status !== 200) throw new Error(`API Error: ${json.error}`);
                allCoords.push(...json.result.filter(res => res.result !== null));
            }
            return allCoords;
        }

        /**
         * Adds or removes markers from the map based on filter controls.
         */
        function updateMapVisibility() {
            const showSolar = document.getElementById('solar-filter').checked;
            const showHeatPump = document.getElementById('heatpump-filter').checked;
            const showEv = document.getElementById('ev-filter').checked;

            let displayedCount = 0;
            allMapMarkers.forEach(marker => {
                // Determine if a marker should be visible
                const shouldShow = 
                    (showSolar && marker.options.hasSolar) ||
                    (showHeatPump && marker.options.hasHeatPump) ||
                    (showEv && marker.options.hasEv);

                if (shouldShow) {
                    marker.addTo(map);
                    displayedCount++;
                } else {
                    marker.removeFrom(map);
                }
            });
            statusElement.textContent = `Displaying ${displayedCount} of ${allMapMarkers.length} locations.`;
        }
        
        /**
         * Sets up the event listeners for the filter checkboxes.
         */
        function setupFilterListeners() {
            document.getElementById('solar-filter').addEventListener('change', updateMapVisibility);
            document.getElementById('heatpump-filter').addEventListener('change', updateMapVisibility);
            document.getElementById('ev-filter').addEventListener('change', updateMapVisibility);
        }

        // Run the main function to start the process
        initializeMap();

    </script>
</body>
</html>
