<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Service Coverage Editor</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --solar-color: #FFD700;
            --heatpump-color: #007BFF;
            --ev-color: #28A745;
            --inactive-color: #6c757d;
            --background-color: #f8f9fa;
            --border-color: #dee2e6;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background-color: #e9ecef; }
        .main-container { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        #map { flex-grow: 1; height: 100%; }
        header, .control-bar { padding: 10px 20px; background-color: var(--background-color); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.5em; }
        .control-bar { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .control-bar strong { font-weight: 600; }
        #filter-controls { display: flex; gap: 20px; }
        #filter-controls label, #edit-panel-toggles label { cursor: pointer; font-size: 0.9em; display: flex; align-items: center; user-select: none; }
        #filter-controls input, #edit-panel-toggles input { margin-right: 8px; }
        #download-btn { padding: 8px 12px; border: 1px solid var(--border-color); background-color: white; border-radius: 5px; cursor: pointer; font-weight: 600; }
        #download-btn:hover { background-color: #f1f1f1; }

        /* Modern Legend */
        .legend {
            padding: 10px 15px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px var(--shadow-color);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        .legend strong { display: block; margin-bottom: 5px; }

        /* Edit Panel */
        #edit-panel {
            width: 280px;
            padding: 20px;
            background-color: white;
            box-shadow: -2px 0 10px var(--shadow-color);
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1001;
            overflow-y: auto;
        }
        #edit-panel.visible { transform: translateX(0); }
        #edit-panel h3 { margin-top: 0; }
        #edit-panel-toggles { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        #close-edit-panel { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #888; }
        #close-edit-panel:hover { color: #000; }
    </style>
</head>
<body>
    <header><h1>Interactive Service Coverage Editor</h1></header>
    <div class="control-bar">
        <strong>Filter by service:</strong>
        <div id="filter-controls">
            <label><input type="checkbox" id="solar-filter" checked> Solar Panels</label>
            <label><input type="checkbox" id="heatpump-filter" checked> Heat Pumps</label>
            <label><input type="checkbox" id="ev-filter" checked> EV Chargers</label>
        </div>
        <button id="download-btn">Download Updated CSV</button>
    </div>

    <div class="main-container">
        <div id="map"></div>
        <div id="edit-panel">
            <button id="close-edit-panel" title="Close">&times;</button>
            <h3 id="edit-panel-title">Edit Services</h3>
            <p>Toggle services for the selected postcode area.</p>
            <div id="edit-panel-toggles">
                <label><input type="checkbox" data-service="hasSolar"> Solar Panels</label>
                <label><input type="checkbox" data-service="hasHeatPump"> Heat Pumps</label>
                <label><input type="checkbox" data-service="hasEv"> EV Chargers</label>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & DOM Elements--- //
        const COLORS = {
            solar: 'var(--solar-color)',
            heatpump: 'var(--heatpump-color)',
            ev: 'var(--ev-color)',
            none: 'var(--inactive-color)'
        };
        const editPanel = document.getElementById('edit-panel');
        let geoJsonLayer;
        let serviceDataByArea = new Map();
        let currentlyEditingArea = null;

        // --- Map Initialization --- //
        const bounds = L.latLngBounds(L.latLng(49, -11), L.latLng(61, 2));
        const map = L.map('map', {
            maxBounds: bounds,
            minZoom: 5
        }).setView([54.5, -2.5], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- Embedded Initial Data (CSV Format) --- //
        const csvData = `Region,Solar Panels,Heat Pumps,Ev Chargers
BD1,0,1,1
BD2,0,1,1
BD3,0,1,1
BD4,0,1,1
BD5,0,1,1
BD6,0,1,1
BD7,0,1,1
BD8,0,1,1
BD9,0,1,1
BD10,0,1,1
BD11,0,1,1
BD12,0,1,1
BD13,0,1,1
BD14,0,1,1
BD15,0,1,1
BD16,0,1,1
BD17,0,1,1
BD18,0,1,1
BD19,0,1,1
BD20,0,1,1
BD21,0,1,1
BD22,0,1,1
BD23,0,1,1
BD24,0,1,1
BD97,0,1,1
BD98,0,1,1
BD99,0,1,1
HG1,0,1,1
HG2,0,1,1
HG3,0,1,1
HG4,0,1,1
HG5,0,1,1
PR0,0,1,1
PR1,0,1,1
PR2,0,1,1
PR3,0,1,1
PR4,0,1,1
PR5,0,1,1
PR6,0,1,1
PR7,0,1,1
PR8,0,1,1
PR9,0,1,1
PR11,0,1,1
PR25,0,1,1
PR26,0,1,1
BB0,0,1,1
BB1,0,1,1
BB2,0,1,1
BB3,0,1,1
BB4,0,1,1
BB5,0,1,1
BB6,0,1,1
BB7,0,1,1
BB8,0,1,1
BB9,0,1,1
BB10,0,1,1
BB11,0,1,1
BB12,0,1,1
BB18,0,1,1
BB94,0,1,1
L1,0,1,1
L2,0,1,1
L3,0,1,1
L4,0,1,1
L5,0,1,1
L6,0,1,1
L7,0,1,1
L8,0,1,1
L9,0,1,1
L10,0,1,1
L11,0,1,1
L12,0,1,1
L13,0,1,1
L14,0,1,1
L15,0,1,1
L16,0,1,1
L17,0,1,1
L18,0,1,1
L19,0,1,1
L20,0,1,1
L21,0,1,1
L22,0,1,1
L23,0,1,1
L24,0,1,1
L25,0,1,1
L26,0,1,1
L27,0,1,1
L28,0,1,1
L29,0,1,1
L30,0,1,1
L31,0,1,1
L32,0,1,1
L33,0,1,1
L34,0,1,1
L35,0,1,1
L36,0,1,1
L37,0,1,1
L38,0,1,1
L39,0,1,1
L40,0,1,1
L67,0,1,1
L68,0,1,1
L69,0,1,1
L70,0,1,1
L71,0,1,1
L72,0,1,1
L73,0,1,1
L74,0,1,1
L75,0,1,1
L80,0,1,1
WN1,0,1,1
WN2,0,1,1
WN3,0,1,1
WN4,0,1,1
WN5,0,1,1
WN6,0,1,1
WN7,0,1,1
WN8,0,1,1
BL0,0,1,1
BL1,0,1,1
BL2,0,1,1
BL3,0,1,1
BL4,0,1,1
BL5,0,1,1
BL6,0,1,1
BL7,0,1,1
BL8,0,1,1
BL9,0,1,1
OL1,0,1,1
OL2,0,1,1
OL3,0,1,1
OL4,0,1,1
OL5,0,1,1
OL6,0,1,1
OL7,0,1,1
OL8,0,1,1
OL9,0,1,1
OL10,0,1,1
OL11,0,1,1
OL12,0,1,1
OL13,0,1,1
OL14,0,1,1
OL15,0,1,1
OL16,0,1,1
OL95,0,1,1
HX1,0,1,1
HX2,0,1,1
HX3,0,1,1
HX4,0,1,1
HX5,0,1,1
HX6,0,1,1
HX7,0,1,1
HD1,0,1,1
HD2,0,1,1
HD3,0,1,1
HD4,0,1,1
HD5,0,1,1
HD6,0,1,1
HD7,0,1,1
HD8,0,1,1
HD9,0,1,1
WF1,0,1,1
WF2,0,1,1
WF3,0,1,1
WF4,0,1,1
WF5,0,1,1
WF6,0,1,1
WF7,0,1,1
WF8,0,1,1
WF9,0,1,1
WF10,0,1,1
WF11,0,1,1
WF12,0,1,1
WF13,0,1,1
WF14,0,1,1
WF15,0,1,1
WF16,0,1,1
WF17,0,1,1
WF90,0,1,1
DN1,0,1,1
DN2,0,1,1
DN3,0,1,1
DN4,0,1,1
DN5,0,1,1
DN6,0,1,1
DN7,0,1,1
DN8,0,1,1
DN9,0,1,1
DN10,0,1,1
DN11,0,1,1
DN12,0,1,1
DN14,0,1,1
DN15,0,1,1
DN16,0,1,1
DN17,0,1,1
DN18,0,1,1
DN19,0,1,1
DN20,0,1,1
DN21,0,1,1
DN22,0,1,1
DN31,0,1,1
DN32,0,1,1
DN33,0,1,1
DN34,0,1,1
DN35,0,1,1
DN36,0,1,1
DN37,0,1,1
DN38,0,1,1
DN39,0,1,1
DN40,0,1,1
DN41,0,1,1
DN55,0,1,1
CH1,0,1,1
CH2,0,1,1
CH3,0,1,1
CH4,0,1,1
CH5,0,1,1
CH6,0,1,1
CH7,0,1,1
CH8,0,1,1
CH25,0,1,1
CH26,0,1,1
CH27,0,1,1
CH28,0,1,1
CH29,0,1,1
CH30,0,1,1
CH31,0,1,1
CH32,0,1,1
CH33,0,1,1
CH34,0,1,1
CH41,0,1,1
CH42,0,1,1
CH43,0,1,1
CH44,0,1,1
CH45,0,1,1
CH46,0,1,1
CH47,0,1,1
CH48,0,1,1
CH49,0,1,1
CH60,0,1,1
CH61,0,1,1
CH62,0,1,1
CH63,0,1,1
CH64,0,1,1
CH65,0,1,1
CH66,0,1,1
CH88,0,1,1
CH99,0,1,1
CW1,0,1,1
CW2,0,1,1
CW3,0,1,1
CW4,0,1,1
CW5,0,1,1
CW6,0,1,1
CW7,0,1,1
CW8,0,1,1
CW9,0,1,1
CW10,0,1,1
CW11,0,1,1
CW12,0,1,1
CW98,0,1,1
WA1,0,1,1
WA2,0,1,1
WA3,0,1,1
WA4,0,1,1
WA5,0,1,1
WA6,0,1,1
WA7,0,1,1
WA8,0,1,1
WA9,0,1,1
WA10,0,1,1
WA11,0,1,1
WA12,0,1,1
WA13,0,1,1
WA14,0,1,1
WA15,0,1,1
WA16,0,1,1
WA55,0,1,1
WA88,0,1,1
M1,0,1,1
M2,0,1,1
M3,0,1,1
M4,0,1,1
M5,0,1,1
M6,0,1,1
M7,0,1,1
M8,0,1,1
M9,0,1,1
M11,0,1,1
M12,0,1,1
M13,0,1,1
M14,0,1,1
M15,0,1,1
M16,0,1,1
M17,0,1,1
M18,0,1,1
M19,0,1,1
M20,0,1,1
M21,0,1,1
M22,0,1,1
M23,0,1,1
M24,0,1,1
M25,0,1,1
M26,0,1,1
M27,0,1,1
M28,0,1,1
M29,0,1,1
M30,0,1,1
M31,0,1,1
M32,0,1,1
M33,0,1,1
M34,0,1,1
M35,0,1,1
M38,0,1,1
M40,0,1,1
M41,0,1,1
M43,0,1,1
M44,0,1,1
M45,0,1,1
M46,0,1,1
M50,0,1,1
M60,0,1,1
M61,0,1,1
M90,0,1,1
M99,0,1,1
SK1,0,1,1
SK2,0,1,1
SK3,0,1,1
SK4,0,1,1
SK5,0,1,1
SK6,0,1,1
SK7,0,1,1
SK8,0,1,1
SK9,0,1,1
SK10,0,1,1
SK11,0,1,1
SK12,0,1,1
SK13,0,1,1
SK14,0,1,1
SK15,0,1,1
SK16,0,1,1
SK17,0,1,1
SK22,0,1,1
SK23,0,1,1
S1,0,1,1
S2,0,1,1
S3,0,1,1
S4,0,1,1
S5,0,1,1
S6,0,1,1
S7,0,1,1
S8,0,1,1
S9,0,1,1
S10,0,1,1
S11,0,1,1
S12,0,1,1
S13,0,1,1
S14,0,1,1
S17,0,1,1
S18,0,1,1
S19,0,1,1
S20,0,1,1
S21,0,1,1
S25,0,1,1
S26,0,1,1
S30,0,1,1
S31,0,1,1
S32,0,1,1
S33,0,1,1
S35,0,1,1
S36,0,1,1
S40,0,1,1
S41,0,1,1
S42,0,1,1
S43,0,1,1
S44,0,1,1
S45,0,1,1
S49,0,1,1
S60,0,1,1
S61,0,1,1
S62,0,1,1
S63,0,1,1
S64,0,1,1
S65,0,1,1
S66,0,1,1
S70,0,1,1
S71,0,1,1
S72,0,1,1
S73,0,1,1
S74,0,1,1
S75,0,1,1
S80,0,1,1
S81,0,1,1
S94,0,1,1
S95,0,1,1
S96,0,1,1
S97,0,1,1
S98,0,1,1
S99,0,1,1
DE1,0,1,1
DE3,0,1,1
DE4,0,1,1
DE5,0,1,1
DE6,0,1,1
DE7,0,1,1
DE11,0,1,1
DE12,0,1,1
DE13,0,1,1
DE14,0,1,1
DE15,0,1,1
DE21,0,1,1
DE22,0,1,1
DE23,0,1,1
DE24,0,1,1
DE45,0,1,1
DE55,0,1,1
DE56,0,1,1
DE65,0,1,1
DE72,0,1,1
DE73,0,1,1
DE74,0,1,1
DE75,0,1,1
DE99,0,1,1
NG1,0,1,1
NG2,0,1,1
NG3,0,1,1
NG4,0,1,1
NG5,0,1,1
NG6,0,1,1
NG7,0,1,1
NG8,0,1,1
NG9,0,1,1
NG10,0,1,1
NG11,0,1,1
NG12,0,1,1
NG13,0,1,1
NG14,0,1,1
NG15,0,1,1
NG16,0,1,1
NG17,0,1,1
NG18,0,1,1
NG19,0,1,1
NG20,0,1,1
NG21,0,1,1
NG22,0,1,1
NG23,0,1,1
NG24,0,1,1
NG25,0,1,1
NG31,0,1,1
NG32,0,1,1
NG33,0,1,1
NG34,0,1,1
NG70,0,1,1
NG80,0,1,1
NG90,0,1,1
LS1,0,1,1
LS2,0,1,1
LS3,0,1,1
LS4,0,1,1
LS5,0,1,1
LS6,0,1,1
LS7,0,1,1
LS8,0,1,1
LS9,0,1,1
LS10,0,1,1
LS11,0,1,1
LS12,0,1,1
LS13,0,1,1
LS14,0,1,1
LS15,0,1,1
LS16,0,1,1
LS17,0,1,1
LS18,0,1,1
LS19,0,1,1
LS20,0,1,1
LS21,0,1,1
LS22,0,1,1
LS23,0,1,1
LS24,0,1,1
LS25,0,1,1
LS26,0,1,1
LS27,0,1,1
LS28,0,1,1
LS29,0,1,1
FY0,0,1,1
FY1,0,1,1
FY2,0,1,1
FY3,0,1,1
FY4,0,1,1
FY5,0,1,1
FY6,0,1,1
FY7,0,1,1
FY8,0,1,1
OX7,1,0,0
OX9,1,0,0
`;

        // --- Embedded GeoJSON Map Data --- //
        // This object contains the boundary data for ALL UK postcode areas. It is now part of the file.
        const geoJsonData = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"AB"},"geometry":{"type":"Polygon","coordinates":[[[-3.0,57.0],[-2.7,57.5],[-2.0,57.7],[-2.2,57.1],[-2.5,56.9],[-3.0,57.0]]]}},{"type":"Feature","properties":{"name":"AL"},"geometry":{"type":"Polygon","coordinates":[[[-0.5,51.7],[-0.1,51.9],[-0.1,51.7],[-0.4,51.6],[-0.5,51.7]]]}},{"type":"Feature","properties":{"name":"B"},"geometry":{"type":"Polygon","coordinates":[[[-2.1,52.3],[-1.7,52.6],[-1.7,52.3],[-2.0,52.2],[-2.1,52.3]]]}},{"type":"Feature","properties":{"name":"BA"},"geometry":{"type":"Polygon","coordinates":[[[-3.0,51.0],[-2.3,51.4],[-2.1,51.2],[-2.7,50.9],[-3.0,51.0]]]}},{"type":"Feature","properties":{"name":"BB"},"geometry":{"type":"Polygon","coordinates":[[[-2.7,53.7],[-2.1,54.0],[-2.1,53.7],[-2.6,53.6],[-2.7,53.7]]]}},{"type":"Feature","properties":{"name":"BD"},"geometry":{"type":"Polygon","coordinates":[[[-2.2,53.8],[-1.6,54.2],[-1.6,53.8],[-2.1,53.7],[-2.2,53.8]]]}},{"type":"Feature","properties":{"name":"BH"},"geometry":{"type":"Polygon","coordinates":[[[-2.3,50.7],[-1.7,51.0],[-1.7,50.7],[-2.2,50.6],[-2.3,50.7]]]}},{"type":"Feature","properties":{"name":"BL"},"geometry":{"type":"Polygon","coordinates":[[[-2.6,53.5],[-2.2,53.7],[-2.2,53.5],[-2.5,53.4],[-2.6,53.5]]]}},{"type":"Feature","properties":{"name":"BN"},"geometry":{"type":"Polygon","coordinates":[[[-0.5,50.8],[-0.0,51.1],[-0.0,50.8],[-0.4,50.7],[-0.5,50.8]]]}},{"type":"Feature","properties":{"name":"BR"},"geometry":{"type":"Polygon","coordinates":[[[-0.1,51.3], [0.1, 51.4], [0.1, 51.3], [-0.1, 51.3]]]}},{"type":"Feature","properties":{"name":"BS"},"geometry":{"type":"Polygon","coordinates":[[[-2.8,51.3],[-2.4,51.6],[-2.4,51.3],[-2.7,51.2],[-2.8,51.3]]]}},{"type":"Feature","properties":{"name":"BT"},"geometry":{"type":"Polygon","coordinates":[[[-8.2,54.2],[-5.3,55.4],[-5.8,54.0],[-7.9,54.0],[-8.2,54.2]]]}},{"type":"Feature","properties":{"name":"CA"},"geometry":{"type":"Polygon","coordinates":[[[-3.6,54.3],[-2.2,55.1],[-2.8,54.2],[-3.5,54.2],[-3.6,54.3]]]}},{"type":"Feature","properties":{"name":"CB"},"geometry":{"type":"Polygon","coordinates":[[[-0.1,52.0], [0.6, 52.6], [0.5, 52.0], [0.0, 51.9], [-0.1,52.0]]]}},{"type":"Feature","properties":{"name":"CF"},"geometry":{"type":"Polygon","coordinates":[[[-3.7,51.4],[-3.0,51.8],[-3.0,51.4],[-3.6,51.3],[-3.7,51.4]]]}},{"type":"Feature","properties":{"name":"CH"},"geometry":{"type":"Polygon","coordinates":[[[-3.3,53.1],[-2.7,53.4],[-2.7,53.1],[-3.2,53.0],[-3.3,53.1]]]}},{"type":"Feature","properties":{"name":"CM"},"geometry":{"type":"Polygon","coordinates":[[[0.2,51.6],[0.9,52.1],[0.8,51.6],[0.3,51.5],[0.2,51.6]]]}},{"type":"Feature","properties":{"name":"CO"},"geometry":{"type":"Polygon","coordinates":[[[0.6,51.7],[1.3,52.1],[1.2,51.7],[0.7,51.6],[0.6,51.7]]]}},{"type":"Feature","properties":{"name":"CR"},"geometry":{"type":"Polygon","coordinates":[[[-0.2,51.3],[0.0,51.4], [0.0,51.3],[-0.2,51.2],[-0.2,51.3]]]}},{"type":"Feature","properties":{"name":"CT"},"geometry":{"type":"Polygon","coordinates":[[[0.8,51.1],[1.4,51.4],[1.4,51.1],[0.9,51.0],[0.8,51.1]]]}},{"type":"Feature","properties":{"name":"CV"},"geometry":{"type":"Polygon","coordinates":[[[-1.8,52.1],[-1.1,52.6],[-1.1,52.2],[-1.7,52.0],[-1.8,52.1]]]}},{"type":"Feature","properties":{"name":"CW"},"geometry":{"type":"Polygon","coordinates":[[[-2.8,53.0],[-2.0,53.4],[-2.0,53.0],[-2.7,52.9],[-2.8,53.0]]]}},{"type":"Feature","properties":{"name":"DA"},"geometry":{"type":"Polygon","coordinates":[[[0.1,51.4],[0.5,51.5],[0.4,51.3],[0.1,51.3],[0.1,51.4]]]}},{"type":"Feature","properties":{"name":"DD"},"geometry":{"type":"Polygon","coordinates":[[[-3.3,56.4],[-2.6,56.8],[-2.6,56.4],[-3.2,56.3],[-3.3,56.4]]]}},{"type":"Feature","properties":{"name":"DE"},"geometry":{"type":"Polygon","coordinates":[[[-1.9,52.7],[-1.2,53.3],[-1.2,52.8],[-1.8,52.6],[-1.9,52.7]]]}},{"type":"Feature","properties":{"name":"DG"},"geometry":{"type":"Polygon","coordinates":[[[-4.6,54.8],[-2.8,55.3],[-3.6,54.7],[-4.5,54.7],[-4.6,54.8]]]}},{"type":"Feature","properties":{"name":"DH"},"geometry":{"type":"Polygon","coordinates":[[[-2.0,54.7],[-1.3,55.0],[-1.4,54.7],[-1.9,54.6],[-2.0,54.7]]]}},{"type":"Feature","properties":{"name":"DL"},"geometry":{"type":"Polygon","coordinates":[[[-2.5,54.2],[-1.2,54.7],[-1.3,54.2],[-2.4,54.1],[-2.5,54.2]]]}},{"type":"Feature","properties":{"name":"DN"},"geometry":{"type":"Polygon","coordinates":[[[-1.2,53.4],[0.1,53.8], [0.0,53.4],[-1.1,53.3],[-1.2,53.4]]]}},{"type":"Feature","properties":{"name":"DT"},"geometry":{"type":"Polygon","coordinates":[[[-2.8,50.6],[-2.0,51.0],[-2.0,50.6],[-2.7,50.5],[-2.8,50.6]]]}},{"type":"Feature","properties":{"name":"DY"},"geometry":{"type":"Polygon","coordinates":[[[-2.4,52.4],[-2.0,52.6],[-2.0,52.4],[-2.3,52.3],[-2.4,52.4]]]}},{"type":"Feature","properties":{"name":"E"},"geometry":{"type":"Polygon","coordinates":[[[-0.1,51.5],[0.1,51.6], [0.1,51.5],[-0.1,51.4],[-0.1,51.5]]]}},{"type":"Feature","properties":{"name":"EC"},"geometry":{"type":"Polygon","coordinates":[[[-0.12,51.5],[-0.07,51.52],[-0.07,51.5],[-0.12,51.5],[-0.12,51.5]]]}},{"type":"Feature","properties":{"name":"EH"},"geometry":{"type":"Polygon","coordinates":[[[-3.8,55.7],[-2.5,56.1],[-2.8,55.6],[-3.7,55.6],[-3.8,55.7]]]}},{"type":"Feature","properties":{"name":"EN"},"geometry":{"type":"Polygon","coordinates":[[[-0.2,51.6],[0.0,51.8], [0.0,51.6],[-0.2,51.5],[-0.2,51.6]]]}},{"type":"Feature","properties":{"name":"EX"},"geometry":{"type":"Polygon","coordinates":[[[-4.2,50.6],[-2.8,51.2],[-3.5,50.5],[-4.1,50.5],[-4.2,50.6]]]}},{"type":"Feature","properties":{"name":"FK"},"geometry":{"type":"Polygon","coordinates":[[[-4.6,56.0],[-3.5,56.4],[-3.6,55.9],[-4.5,55.9],[-4.6,56.0]]]}},{"type":"Feature","properties":{"name":"FY"},"geometry":{"type":"Polygon","coordinates":[[[-3.1,53.7],[-2.7,54.0],[-2.7,53.7],[-3.0,53.6],[-3.1,53.7]]]}},{"type":"Feature","properties":{"name":"G"},"geometry":{"type":"Polygon","coordinates":[[[-4.8,55.8],[-3.8,56.2],[-4.8,55.7],[-4.8,55.8]]]}},{"type":"Feature","properties":{"name":"GL"},"geometry":{"type":"Polygon","coordinates":[[[-2.7,51.6],[-1.8,52.2],[-1.8,51.6],[-2.6,51.5],[-2.7,51.6]]]}},{"type":"Feature","properties":{"name":"GU"},"geometry":{"type":"Polygon","coordinates":[[[-1.1,51.0],[-0.4,51.4],[-0.5,51.0],[-1.0,50.9],[-1.1,51.0]]]}},{"type":"Feature","properties":{"name":"GY"},"geometry":{"type":"Polygon","coordinates":[[[-2.6,49.4],[-2.5,49.5],[-2.5,49.4],[-2.6,49.4]]]}},{"type":"Feature","properties":{"name":"HA"},"geometry":{"type":"Polygon","coordinates":[[[-0.5,51.5],[-0.2,51.7],[-0.2,51.5],[-0.4,51.4],[-0.5,51.5]]]}},{"type":"Feature","properties":{"name":"HD"},"geometry":{"type":"Polygon","coordinates":[[[-2.0,53.5],[-1.6,53.8],[-1.7,53.5],[-2.0,53.4],[-2.0,53.5]]]}},{"type":"Feature","properties":{"name":"HG"},"geometry":{"type":"Polygon","coordinates":[[[-1.9,53.9],[-1.2,54.3],[-1.3,53.9],[-1.8,53.8],[-1.9,53.9]]]}},{"type":"Feature","properties":{"name":"HP"},"geometry":{"type":"Polygon","coordinates":[[[-1.1,51.6],[-0.5,52.0],[-0.5,51.6],[-1.0,51.5],[-1.1,51.6]]]}},{"type":"Feature","properties":{"name":"HR"},"geometry":{"type":"Polygon","coordinates":[[[-3.2,51.9],[-2.4,52.4],[-2.5,51.9],[-3.1,51.8],[-3.2,51.9]]]}},{"type":"Feature","properties":{"name":"HS"},"geometry":{"type":"Polygon","coordinates":[[[-7.6,57.7],[-6.2,58.3],[-6.3,57.6],[-7.5,56.8],[-7.6,57.7]]]}},{"type":"Feature","properties":{"name":"HU"},"geometry":{"type":"Polygon","coordinates":[[[-0.8,53.6],[0.1,54.1],[0.0,53.6],[-0.7,53.5],[-0.8,53.6]]]}},{"type":"Feature","properties":{"name":"HX"},"geometry":{"type":"Polygon","coordinates":[[[-2.1,53.6],[-1.7,53.9],[-1.8,53.6],[-2.0,53.5],[-2.1,53.6]]]}},{"type":"Feature","properties":{"name":"IG"},"geometry":{"type":"Polygon","coordinates":[[[0.0,51.5],[0.2,51.6],[0.2,51.5],[0.0,51.5]]]}},{"type":"Feature","properties":{"name":"IM"},"geometry":{"type":"Polygon","coordinates":[[[-4.8,54.0],[-4.3,54.4],[-4.3,54.1],[-4.7,54.0],[-4.8,54.0]]]}},{"type":"Feature","properties":{"name":"IP"},"geometry":{"type":"Polygon","coordinates":[[[0.7,51.9],[1.6,52.5],[1.5,51.9],[0.8,51.8],[0.7,51.9]]]}},{"type":"Feature","properties":{"name":"IV"},"geometry":{"type":"Polygon","coordinates":[[[-5.8,57.0],[-3.5,58.6],[-4.0,57.0],[-5.5,56.8],[-5.8,57.0]]]}},{"type":"Feature","properties":{"name":"JE"},"geometry":{"type":"Polygon","coordinates":[[[-2.2,49.1],[-2.0,49.3],[-2.0,49.1],[-2.2,49.1]]]}},{"type":"Feature","properties":{"name":"KA"},"geometry":{"type":"Polygon","coordinates":[[[-5.2,55.3],[-4.2,55.9],[-4.3,55.2],[-5.1,55.2],[-5.2,55.3]]]}},{"type":"Feature","properties":{"name":"KT"},"geometry":{"type":"Polygon","coordinates":[[[-0.5,51.3],[-0.2,51.5],[-0.2,51.3],[-0.4,51.2],[-0.5,51.3]]]}},{"type":"Feature","properties":{"name":"KW"},"geometry":{"type":"Polygon","coordinates":[[[-4.2,58.1],[-2.8,59.2],[-3.5,58.0],[-4.1,58.0],[-4.2,58.1]]]}},{"type":"Feature","properties":{"name":"KY"},"geometry":{"type":"Polygon","coordinates":[[[-3.5,56.0],[-2.6,56.4],[-2.7,56.0],[-3.4,55.9],[-3.5,56.0]]]}},{"type":"Feature","properties":{"name":"L"},"geometry":{"type":"Polygon","coordinates":[[[-3.2,53.3],[-2.7,53.6],[-2.7,53.3],[-3.1,53.2],[-3.2,53.3]]]}},{"type":"Feature","properties":{"name":"LA"},"geometry":{"type":"Polygon","coordinates":[[[-3.2,54.0],[-2.4,54.5],[-2.5,53.9],[-3.1,53.9],[-3.2,54.0]]]}},{"type":"Feature","properties":{"name":"LD"},"geometry":{"type":"Polygon","coordinates":[[[-3.8,52.0],[-2.9,52.5],[-3.0,51.9],[-3.7,51.9],[-3.8,52.0]]]}},{"type":"Feature","properties":{"name":"LE"},"geometry":{"type":"Polygon","coordinates":[[[-1.5,52.5],[-0.6,52.9],[-0.7,52.5],[-1.4,52.4],[-1.5,52.5]]]}},{"type":"Feature","properties":{"name":"LL"},"geometry":{"type":"Polygon","coordinates":[[[-4.8,52.7],[-2.8,53.4],[-3.5,52.6],[-4.7,52.6],[-4.8,52.7]]]}},{"type":"Feature","properties":{"name":"LN"},"geometry":{"type":"Polygon","coordinates":[[[-0.9,53.0],[0.1,53.6],[0.0,53.0],[-0.8,52.9],[-0.9,53.0]]]}},{"type":"Feature","properties":{"name":"LS"},"geometry":{"type":"Polygon","coordinates":[[[-1.8,53.7],[-1.3,54.0],[-1.3,53.7],[-1.7,53.6],[-1.8,53.7]]]}},{"type":"Feature","properties":{"name":"LU"},"geometry":{"type":"Polygon","coordinates":[[[-0.6,51.8],[-0.3,52.0],[-0.3,51.8],[-0.5,51.7],[-0.6,51.8]]]}},{"type":"Feature","properties":{"name":"M"},"geometry":{"type":"Polygon","coordinates":[[[-2.4,53.4],[-2.1,53.6],[-2.1,53.4],[-2.3,53.3],[-2.4,53.4]]]}},{"type":"Feature","properties":{"name":"ME"},"geometry":{"type":"Polygon","coordinates":[[[0.3,51.2],[1.0,51.5],[0.9,51.2],[0.4,51.1],[0.3,51.2]]]}},{"type":"Feature","properties":{"name":"MK"},"geometry":{"type":"Polygon","coordinates":[[[-1.1,51.9],[-0.5,52.3],[-0.5,51.9],[-1.0,51.8],[-1.1,51.9]]]}},{"type":"Feature","properties":{"name":"ML"},"geometry":{"type":"Polygon","coordinates":[[[-4.3,55.5],[-3.3,55.9],[-3.4,55.4],[-4.2,55.4],[-4.3,55.5]]]}},{"type":"Feature","properties":{"name":"N"},"geometry":{"type":"Polygon","coordinates":[[[-0.2,51.5],[-0.0,51.6],[-0.0,51.5],[-0.2,51.5]]]}},{"type":"Feature","properties":{"name":"NE"},"geometry":{"type":"Polygon","coordinates":[[[-2.6,54.9],[-1.3,55.6],[-1.5,54.8],[-2.5,54.8],[-2.6,54.9]]]}},{"type":"Feature","properties":{"name":"NG"},"geometry":{"type":"Polygon","coordinates":[[[-1.4,52.8],[ -0.5, 53.4],[-0.6,52.8],[-1.3,52.7],[-1.4,52.8]]]}},{"type":"Feature","properties":{"name":"NN"},"geometry":{"type":"Polygon","coordinates":[[[-1.4,52.0],[-0.5,52.5],[-0.6,52.0],[-1.3,51.9],[-1.4,52.0]]]}},{"type":"Feature","properties":{"name":"NP"},"geometry":{"type":"Polygon","coordinates":[[[-3.3,51.5],[-2.7,51.9],[-2.7,51.5],[-3.2,51.4],[-3.3,51.5]]]}},{"type":"Feature","properties":{"name":"NR"},"geometry":{"type":"Polygon","coordinates":[[[0.8,52.4],[1.8,53.0],[1.7,52.4],[0.9,52.3],[0.8,52.4]]]}},{"type":"Feature","properties":{"name":"NW"},"geometry":{"type":"Polygon","coordinates":[[[-0.3,51.5],[-0.1,51.6],[-0.1,51.5],[-0.3,51.4],[-0.3,51.5]]]}},{"type":"Feature","properties":{"name":"OL"},"geometry":{"type":"Polygon","coordinates":[[[-2.3,53.5],[-1.8,53.8],[-1.8,53.5],[-2.2,53.4],[-2.3,53.5]]]}},{"type":"Feature","properties":{"name":"OX"},"geometry":{"type":"Polygon","coordinates":[[[-1.8,51.5],[-0.8,52.2],[-0.9,51.5],[-1.7,51.4],[-1.8,51.5]]]}},{"type":"Feature","properties":{"name":"PA"},"geometry":{"type":"Polygon","coordinates":[[[-6.4,55.6],[-4.4,56.6],[-5.2,55.5],[-6.3,55.5],[-6.4,55.6]]]}},{"type":"Feature","properties":{"name":"PE"},"geometry":{"type":"Polygon","coordinates":[[[-0.8,52.4],[0.6,53.0],[0.5,52.4],[-0.7,52.3],[-0.8,52.4]]]}},{"type":"Feature","properties":{"name":"PH"},"geometry":{"type":"Polygon","coordinates":[[[-5.2,56.3],[-3.0,57.2],[-3.8,56.2],[-5.1,56.2],[-5.2,56.3]]]}},{"type":"Feature","properties":{"name":"PL"},"geometry":{"type":"Polygon","coordinates":[[[-4.8,50.3],[-3.8,50.8],[-4.0,50.2],[-4.7,50.2],[-4.8,50.3]]]}},{"type":"Feature","properties":{"name":"PO"},"geometry":{"type":"Polygon","coordinates":[[[-1.8,50.6],[-0.6,51.1],[-0.7,50.6],[-1.7,50.5],[-1.8,50.6]]]}},{"type":"Feature","properties":{"name":"PR"},"geometry":{"type":"Polygon","coordinates":[[[-3.1,53.6],[-2.5,54.0],[-2.5,53.6],[-3.0,53.5],[-3.1,53.6]]]}},{"type":"Feature","properties":{"name":"RG"},"geometry":{"type":"Polygon","coordinates":[[[-1.5,51.3],[-0.7,51.6],[-0.7,51.3],[-1.4,51.2],[-1.5,51.3]]]}},{"type":"Feature","properties":{"name":"RH"},"geometry":{"type":"Polygon","coordinates":[[[-0.6,51.0],[0.1,51.4],[0.0,51.0],[-0.5,50.9],[-0.6,51.0]]]}},{"type":"Feature","properties":{"name":"RM"},"geometry":{"type":"Polygon","coordinates":[[[0.1,51.5],[0.3,51.7],[0.3,51.5],[0.1,51.4], [0.1,51.5]]]}},{"type":"Feature","properties":{"name":"S"},"geometry":{"type":"Polygon","coordinates":[[[-1.8,53.2],[-1.0,53.6],[-1.1,53.2],[-1.7,53.1],[-1.8,53.2]]]}},{"type":"Feature","properties":{"name":"SA"},"geometry":{"type":"Polygon","coordinates":[[[-5.3,51.6],[-3.6,52.4],[-4.2,51.5],[-5.2,51.5],[-5.3,51.6]]]}},{"type":"Feature","properties":{"name":"SE"},"geometry":{"type":"Polygon","coordinates":[[[-0.1,51.4],[0.1,51.5],[0.1,51.4],[-0.1,51.4]]]}},{"type":"Feature","properties":{"name":"SG"},"geometry":{"type":"Polygon","coordinates":[[[-0.4,51.8],[0.2,52.2],[0.1,51.8],[-0.3,51.7],[-0.4,51.8]]]}},{"type":"Feature","properties":{"name":"SK"},"geometry":{"type":"Polygon","coordinates":[[[-2.4,53.2],[-1.7,53.6],[-1.8,53.2],[-2.3,53.1],[-2.4,53.2]]]}},{"type":"Feature","properties":{"name":"SL"},"geometry":{"type":"Polygon","coordinates":[[[-0.8,51.4],[-0.4,51.7],[-0.4,51.4],[-0.7,51.3],[-0.8,51.4]]]}},{"type":"Feature","properties":{"name":"SM"},"geometry":{"type":"Polygon","coordinates":[[[-0.3,51.3],[-0.1,51.4],[-0.1,51.3],[-0.2,51.3],[-0.3,51.3]]]}},{"type":"Feature","properties":{"name":"SN"},"geometry":{"type":"Polygon","coordinates":[[[-2.2,51.3],[-1.5,51.7],[-1.5,51.3],[-2.1,51.2],[-2.2,51.3]]]}},{"type":"Feature","properties":{"name":"SO"},"geometry":{"type":"Polygon","coordinates":[[[-1.8,50.8],[-1.1,51.2],[-1.1,50.8],[-1.7,50.7],[-1.8,50.8]]]}},{"type":"Feature","properties":{"name":"SP"},"geometry":{"type":"Polygon","coordinates":[[[-2.3,50.9],[-1.5,51.3],[-1.6,50.9],[-2.2,50.8],[-2.3,50.9]]]}},{"type":"Feature","properties":{"name":"SR"},"geometry":{"type":"Polygon","coordinates":[[[-1.6,54.8],[-1.3,55.0],[-1.3,54.8],[-1.5,54.7],[-1.6,54.8]]]}},{"type":"Feature","properties":{"name":"SS"},"geometry":{"type":"Polygon","coordinates":[[[0.4,51.5],[1.0,51.7],[0.9,51.5],[0.5,51.4],[0.4,51.5]]]}},{"type":"Feature","properties":{"name":"ST"},"geometry":{"type":"Polygon","coordinates":[[[-2.5,52.7],[-1.7,53.2],[-1.8,52.7],[-2.4,52.6],[-2.5,52.7]]]}},{"type":"Feature","properties":{"name":"SW"},"geometry":{"type":"Polygon","coordinates":[[[-0.25,51.4],[-0.1,51.5],[-0.1,51.4],[-0.25,51.4]]]}},{"type":"Feature","properties":{"name":"SY"},"geometry":{"type":"Polygon","coordinates":[[[-3.8,52.4],[-2.4,53.0],[-2.5,52.3],[-3.7,52.3],[-3.8,52.4]]]}},{"type":"Feature","properties":{"name":"TA"},"geometry":{"type":"Polygon","coordinates":[[[-3.7,50.8],[-2.7,51.3],[-2.8,50.8],[-3.6,50.7],[-3.7,50.8]]]}},{"type":"Feature","properties":{"name":"TD"},"geometry":{"type":"Polygon","coordinates":[[[-3.4,55.4],[-1.8,55.9],[-2.0,55.3],[-3.3,55.3],[-3.4,55.4]]]}},{"type":"Feature","properties":{"name":"TF"},"geometry":{"type":"Polygon","coordinates":[[[-2.7,52.6],[-2.3,52.8],[-2.3,52.6],[-2.6,52.5],[-2.7,52.6]]]}},{"type":"Feature","properties":{"name":"TN"},"geometry":{"type":"Polygon","coordinates":[[[0.0,50.9],[0.9,51.4],[0.8,50.9],[0.1,50.8],[0.0,50.9]]]}},{"type":"Feature","properties":{"name":"TQ"},"geometry":{"type":"Polygon","coordinates":[[[-4.1,50.3],[-3.4,50.7],[-3.5,50.2],[-4.0,50.2],[-4.1,50.3]]]}},{"type":"Feature","properties":{"name":"TR"},"geometry":{"type":"Polygon","coordinates":[[[-5.8,49.9],[-4.8,50.6],[-5.0,49.9],[-5.7,49.8],[-5.8,49.9]]]}},{"type":"Feature","properties":{"name":"TS"},"geometry":{"type":"Polygon","coordinates":[[[-1.6,54.4],[-0.8,54.7],[-0.9,54.4],[-1.5,54.3],[-1.6,54.4]]]}},{"type":"Feature","properties":{"name":"TW"},"geometry":{"type":"Polygon","coordinates":[[[-0.5,51.4],[-0.3,51.5],[-0.3,51.4],[-0.5,51.4]]]}},{"type":"Feature","properties":{"name":"UB"},"geometry":{"type":"Polygon","coordinates":[[[-0.5,51.4],[-0.3,51.6],[-0.3,51.4],[-0.5,51.4]]]}},{"type":"Feature","properties":{"name":"W"},"geometry":{"type":"Polygon","coordinates":[[[-0.4,51.5],[-0.1,51.6],[-0.2,51.4],[-0.4,51.4],[-0.4,51.5]]]}},{"type":"Feature","properties":{"name":"WA"},"geometry":{"type":"Polygon","coordinates":[[[-2.9,53.2],[-2.2,53.6],[-2.3,53.2],[-2.8,53.1],[-2.9,53.2]]]}},{"type":"Feature","properties":{"name":"WC"},"geometry":{"type":"Polygon","coordinates":[[[-0.14,51.5],[-0.1,51.52],[-0.1,51.5],[-0.14,51.5]]]}},{"type":"Feature","properties":{"name":"WD"},"geometry":{"type":"Polygon","coordinates":[[[-0.5,51.6],[-0.2,51.8],[-0.2,51.6],[-0.4,51.5],[-0.5,51.6]]]}},{"type":"Feature","properties":{"name":"WF"},"geometry":{"type":"Polygon","coordinates":[[[-1.8,53.6],[-1.2,53.9],[-1.3,53.6],[-1.7,53.5],[-1.8,53.6]]]}},{"type":"Feature","properties":{"name":"WN"},"geometry":{"type":"Polygon","coordinates":[[[-2.8,53.4],[-2.4,53.7],[-2.5,53.4],[-2.8,53.4]]]}},{"type":"Feature","properties":{"name":"WR"},"geometry":{"type":"Polygon","coordinates":[[[-2.6,52.0],[-1.8,52.4],[-1.9,52.0],[-2.5,51.9],[-2.6,52.0]]]}},{"type":"Feature","properties":{"name":"WS"},"geometry":{"type":"Polygon","coordinates":[[[-2.2,52.5],[-1.8,52.8],[-1.8,52.5],[-2.1,52.4],[-2.2,52.5]]]}},{"type":"Feature","properties":{"name":"WV"},"geometry":{"type":"Polygon","coordinates":[[[-2.4,52.5],[-2.0,52.8],[-2.0,52.5],[-2.3,52.4],[-2.4,52.5]]]}},{"type":"Feature","properties":{"name":"YO"},"geometry":{"type":"Polygon","coordinates":[[[-1.5,53.8],[ -0.2, 54.5],[-0.4,53.8],[-1.4,53.7],[-1.5,53.8]]]}},{"type":"Feature","properties":{"name":"ZE"},"geometry":{"type":"Polygon","coordinates":[[[-1.8,59.8],[-0.8,60.9],[-1.4,59.7],[-1.7,59.7],[-1.8,59.8]]]}}]};

        // --- Main Application Logic --- //
        
        function initializeMap() {
            try {
                processServiceData();
                geoJsonLayer = L.geoJSON(geoJsonData, {
                    style: styleFeature,
                    onEachFeature: onEachFeature
                }).addTo(map);
                setupEventListeners();
                addLegend();
            } catch (error) {
                console.error("Map Initialization Error:", error);
            }
        }
        
        function simpleCsvParse(csvString) {
            const rows = csvString.trim().split('\n');
            const headers = rows.shift().split(',');
            return rows.map(rowString => {
                const values = rowString.split(',');
                let obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });
        }

        function processServiceData() {
            const parsedData = simpleCsvParse(csvData);
            parsedData.forEach(row => {
                if (!row.Region) return;
                const match = row.Region.match(/^[A-Z]+/);
                if (!match) return;
                const area = match[0];
                if (!serviceDataByArea.has(area)) {
                    serviceDataByArea.set(area, { hasSolar: false, hasHeatPump: false, hasEv: false });
                }
                const currentData = serviceDataByArea.get(area);
                if (row['Solar Panels'] === '1') currentData.hasSolar = true;
                if (row['Heat Pumps'] === '1') currentData.hasHeatPump = true;
                if (row['Ev Chargers'] === '1') currentData.hasEv = true;
            });
        }

        function styleFeature(feature) {
            const showSolar = document.getElementById('solar-filter').checked;
            const showHeatPump = document.getElementById('heatpump-filter').checked;
            const showEv = document.getElementById('ev-filter').checked;
            const areaCode = feature.properties.name;
            const data = serviceDataByArea.get(areaCode);
            let color = COLORS.none;
            let fillOpacity = 0.2;
            if (data) {
                if (showSolar && data.hasSolar) { color = COLORS.solar; fillOpacity = 0.7; } 
                else if (showHeatPump && data.hasHeatPump) { color = COLORS.heatpump; fillOpacity = 0.7; } 
                else if (showEv && data.hasEv) { color = COLORS.ev; fillOpacity = 0.7; }
            }
            return { fillColor: color, weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: fillOpacity };
        }

        function onEachFeature(feature, layer) {
            const areaCode = feature.properties.name;
            layer.bindPopup(generatePopupContent(areaCode));
            layer.on({
                mouseover: e => e.target.setStyle({ weight: 4, color: '#333', dashArray: '' }),
                mouseout: e => geoJsonLayer.resetStyle(e.target),
                click: e => openEditPanel(areaCode, layer)
            });
        }

        function generatePopupContent(areaCode) {
            const data = serviceDataByArea.get(areaCode);
            let content = `<b>Postcode Area: ${areaCode}</b>`;
            if (data) {
                content += `<br><hr>Services Available:`;
                if (!data.hasSolar && !data.hasHeatPump && !data.hasEv) content += '<br>None';
                if (data.hasSolar) content += `<br>✔️ Solar Panels`;
                if (data.hasHeatPump) content += `<br>✔️ Heat Pumps`;
                if (data.hasEv) content += `<br>✔️ EV Chargers`;
            } else {
                 content += `<br><hr>No services defined for this area.`;
            }
            content += `<br><br><i>Click to edit services.</i>`;
            return content;
        }

        function openEditPanel(areaCode, layer) {
            currentlyEditingArea = { code: areaCode, layer: layer };
            if (!serviceDataByArea.has(areaCode)) {
                serviceDataByArea.set(areaCode, { hasSolar: false, hasHeatPump: false, hasEv: false });
            }
            const data = serviceDataByArea.get(areaCode);
            document.getElementById('edit-panel-title').innerText = `Edit Services for ${areaCode}`;
            document.querySelector('#edit-panel-toggles [data-service="hasSolar"]').checked = data.hasSolar;
            document.querySelector('#edit-panel-toggles [data-service="hasHeatPump"]').checked = data.hasHeatPump;
            document.querySelector('#edit-panel-toggles [data-service="hasEv"]').checked = data.hasEv;
            editPanel.classList.add('visible');
        }

        function closeEditPanel() {
            editPanel.classList.remove('visible');
            currentlyEditingArea = null;
        }

        function handleServiceEdit(e) {
            if (!currentlyEditingArea) return;
            const service = e.target.dataset.service;
            const isEnabled = e.target.checked;
            const areaCode = currentlyEditingArea.code;
            const data = serviceDataByArea.get(areaCode);
            data[service] = isEnabled;
            currentlyEditingArea.layer.setStyle(styleFeature(currentlyEditingArea.layer.feature));
            currentlyEditingArea.layer.setPopupContent(generatePopupContent(areaCode));
        }

        function generateAndDownloadCsv() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Area,Solar Panels,Heat Pumps,Ev Chargers\r\n";
            const sortedAreas = [...serviceDataByArea.keys()].sort();
            sortedAreas.forEach(area => {
                const services = serviceDataByArea.get(area);
                const row = [area, services.hasSolar ? '1' : '0', services.hasHeatPump ? '1' : '0', services.hasEv ? '1' : '0'].join(',');
                csvContent += row + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "updated_service_coverage.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function setupEventListeners() {
            document.querySelectorAll('#filter-controls input').forEach(cb => cb.addEventListener('change', () => geoJsonLayer.setStyle(styleFeature)));
            document.getElementById('close-edit-panel').addEventListener('click', closeEditPanel);
            document.querySelectorAll('#edit-panel-toggles input').forEach(cb => cb.addEventListener('change', handleServiceEdit));
            document.getElementById('download-btn').addEventListener('click', generateAndDownloadCsv);
        }
        
        function addLegend() {
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend');
                let labels = ['<strong>Service Colour Key</strong>(Priority Order)'];
                const COLORS_FOR_LEGEND = {
                    solar: 'var(--solar-color)',
                    heatpump: 'var(--heatpump-color)',
                    ev: 'var(--ev-color)',
                    none: 'var(--inactive-color)'
                };
                for (const service in COLORS_FOR_LEGEND) {
                    let serviceName = service.charAt(0).toUpperCase() + service.slice(1);
                    if (service === 'none') serviceName = "Inactive/None";
                    labels.push(`<i style="background:${COLORS_FOR_LEGEND[service]}"></i> ${serviceName}`);
                }
                div.innerHTML = labels.join('<br>');
                return div;
            };
            legend.addTo(map);
        }

        initializeMap();
    </script>
</body>
</html>
