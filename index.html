<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Coverage Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

    <style>
        /* Basic styling for the page */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        h1 {
            margin: 0;
            font-size: 1.5em;
        }
        #status {
            padding: 0 20px 10px;
            font-style: italic;
            color: #6c757d;
        }
        /* Make the map container fill the available space */
        #map {
            flex-grow: 1; /* This makes the map fill the remaining height */
            width: 100%;
            background-color: #e9ecef; /* Light grey background while map loads */
        }
    </style>
</head>
<body>

    <header>
        <h1>Service Launch Coverage</h1>
    </header>
    <div id="status">Initializing map...</div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- Configuration --- //
        const CSV_FILE_NAME = 'Postcode list_16.01_AEMLaunchCoverage.csv';
        const MAP_CENTER_COORDS = [54.5, -3.4]; // Centered on the UK
        const MAP_INITIAL_ZOOM = 6;
        const POSTCODES_API_URL = 'https://api.postcodes.io/postcodes';
        const BATCH_SIZE = 100; // API can handle up to 100 postcodes per request

        // --- Map Initialization --- //
        const map = L.map('map').setView(MAP_CENTER_COORDS, MAP_INITIAL_ZOOM);
        const statusElement = document.getElementById('status');

        // Add a tile layer to the map (the map background imagery)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        /**
         * The main function to load and plot the data.
         */
        async function loadAndPlotData() {
            try {
                // --- Step 1: Fetch and Parse the CSV file --- //
                statusElement.textContent = `Loading coverage data from ${CSV_FILE_NAME}...`;
                
                // Use fetch() to get the file from your repository
                const response = await fetch(CSV_FILE_NAME);
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV file. Status: ${response.status}. Make sure the file '${CSV_FILE_NAME}' is in the same folder as this HTML file in your repository.`);
                }
                const csvText = await response.text();
                
                // Use PapaParse to convert CSV text to an array of objects
                const parsedData = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;

                // --- Step 2: Extract postcodes for API lookup --- //
                const postcodes = parsedData.map(row => row.Region).filter(pc => pc); // Get all postcodes, filter out empty ones
                if (postcodes.length === 0) {
                    throw new Error("No postcodes found in the 'Region' column of the CSV.");
                }
                statusElement.textContent = `Found ${postcodes.length} postcodes. Now fetching coordinates...`;

                // --- Step 3: Fetch coordinates in batches from postcodes.io --- //
                let allCoordinates = [];
                for (let i = 0; i < postcodes.length; i += BATCH_SIZE) {
                    const batch = postcodes.slice(i, i + BATCH_SIZE);
                    const apiResponse = await fetch(POSTCODES_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ postcodes: batch })
                    });
                    const json = await apiResponse.json();
                    if (json.status !== 200) {
                        throw new Error(`API Error: ${json.error}`);
                    }
                    // Filter out null results for invalid postcodes
                    const validResults = json.result.filter(res => res.result !== null);
                    allCoordinates.push(...validResults);
                }
                statusElement.textContent = `Successfully found coordinates for ${allCoordinates.length} of ${postcodes.length} postcodes. Plotting on map...`;

                // --- Step 4: Create a lookup map for easy access to your original data --- //
                const coverageDataMap = new Map();
                parsedData.forEach(row => coverageDataMap.set(row.Region, row));

                // --- Step 5: Plot markers on the map --- //
                allCoordinates.forEach(data => {
                    const postcodeInfo = data.result;
                    const originalRow = coverageDataMap.get(postcodeInfo.postcode);

                    if (originalRow) {
                        // Create the text for the popup window
                        let popupContent = `<b>Postcode: ${originalRow.Region}</b><br><hr>`;
                        popupContent += `Solar Panels: ${originalRow['Solar Panels'] === '1' ? '✔️ Yes' : '❌ No'}<br>`;
                        popupContent += `Heat Pumps: ${originalRow['Heat Pumps'] === '1' ? '✔️ Yes' : '❌ No'}<br>`;
                        popupContent += `EV Chargers: ${originalRow['Ev Chargers'] === '1' ? '✔️ Yes' : '❌ No'}`;

                        // Create a marker and bind the popup to it
                        L.marker([postcodeInfo.latitude, postcodeInfo.longitude])
                            .addTo(map)
                            .bindPopup(popupContent);
                    }
                });

                statusElement.textContent = `Done. ${allCoordinates.length} locations plotted on the map.`;

            } catch (error) {
                // Display any errors in the status area and the console
                console.error("Map Error:", error);
                statusElement.innerHTML = `<strong>Error:</strong> ${error.message}. <br>Please check the developer console (F12) for more details.`;
                statusElement.style.color = 'red';
            }
        }

        // Run the main function when the page loads
        loadAndPlotData();

    </script>
</body>
</html>
