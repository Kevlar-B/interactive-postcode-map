<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Coverage Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        header { padding: 10px 20px; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        h1 { margin: 0; font-size: 1.5em; display: inline-block; vertical-align: middle; }
        #status { padding: 5px 20px 10px; font-style: italic; color: #6c757d; }
        #map { flex-grow: 1; width: 100%; background-color: #e9ecef; }
        #filter-controls { display: flex; gap: 20px; padding: 10px 20px; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; flex-wrap: wrap; }
        #filter-controls label { cursor: pointer; font-size: 0.9em; display: flex; align-items: center; }
        #filter-controls input { margin-right: 8px; }
        .legend { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.9; border: 1px solid #555; }
    </style>
</head>
<body>

    <header><h1>Service Launch Coverage</h1></header>

    <div id="filter-controls">
        <strong>Filter by service:</strong>
        <label><input type="checkbox" id="solar-filter" checked> Solar Panels</label>
        <label><input type="checkbox" id="heatpump-filter" checked> Heat Pumps</label>
        <label><input type="checkbox" id="ev-filter" checked> EV Chargers</label>
    </div>
    
    <div id="status">Initializing map...</div>
    <div id="map"></div>

    <script>
        // --- Configuration --- //
        const GEOJSON_URL = 'https://raw.githubusercontent.com/martinjc/UK-GeoJSON/master/json/administrative/gb/pfa.json';
        const STATUS_ELEMENT = document.getElementById('status');
        const COLORS = {
            solar: '#FFD700', // Gold
            heatpump: '#007BFF', // Blue
            ev: '#28A745', // Green
            none: '#6c757d' // Grey for inactive
        };
        let geoJsonLayer;
        let serviceDataByArea = new Map();

        // --- Map Initialization --- //
        const bounds = L.latLngBounds(L.latLng(49, -11), L.latLng(61, 2)); // UK and Ireland
        const map = L.map('map', {
            maxBounds: bounds,
            minZoom: 6
        }).setView([54.5, -2.5], 6); // Centered on UK

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- Embedded Postcode Data --- //
        const csvData = `
Region,Solar Panels,Heat Pumps,Ev Chargers
BD1,0,1,1, ... // Your full data remains here
OX9,1,0,0
`;

        /**
         * The main function to initialize the map.
         */
        async function initializeMap() {
            try {
                STATUS_ELEMENT.textContent = 'Processing service data...';
                processServiceData();

                STATUS_ELEMENT.textContent = 'Downloading map area data...';
                const response = await fetch(GEOJSON_URL);
                if (!response.ok) throw new Error('Failed to download map data.');
                const geoJsonData = await response.json();

                STATUS_ELEMENT.textContent = 'Creating map layers...';
                geoJsonLayer = L.geoJSON(geoJsonData, {
                    style: styleFeature,
                    onEachFeature: onEachFeature
                }).addTo(map);
                
                setupFilterListeners();
                addLegend();
                STATUS_ELEMENT.textContent = 'Map ready.';

            } catch (error) {
                console.error("Map Initialization Error:", error);
                STATUS_ELEMENT.innerHTML = `<strong>Error:</strong> ${error.message}`;
                STATUS_ELEMENT.style.color = 'red';
            }
        }

        /**
         * Parses the raw CSV data and aggregates it by postcode area (e.g., 'BD', 'HG').
         */
        function processServiceData() {
            const parsed = Papa.parse(csvData.trim(), { header: true, skipEmptyLines: true });
            if (parsed.errors.length) {
                console.error("Parsing Errors:", parsed.errors);
                throw new Error("Failed to parse the embedded postcode data.");
            }
            
            parsed.data.forEach(row => {
                // Extract the postcode area (e.g., 'BD' from 'BD1', 'S' from 'S10')
                const area = row.Region.match(/^[A-Z]+/)[0];
                if (!area) return;

                if (!serviceDataByArea.has(area)) {
                    serviceDataByArea.set(area, { hasSolar: false, hasHeatPump: false, hasEv: false });
                }

                const currentData = serviceDataByArea.get(area);
                if (row['Solar Panels'] === '1') currentData.hasSolar = true;
                if (row['Heat Pumps'] === '1') currentData.hasHeatPump = true;
                if (row['Ev Chargers'] === '1') currentData.hasEv = true;
            });
        }

        /**
         * Determines the style (color) of a postcode area polygon.
         */
        function styleFeature(feature) {
            const showSolar = document.getElementById('solar-filter').checked;
            const showHeatPump = document.getElementById('heatpump-filter').checked;
            const showEv = document.getElementById('ev-filter').checked;

            const areaName = feature.properties.PFA_NAME.substring(0, feature.properties.PFA_NAME.indexOf(' '));
            const data = serviceDataByArea.get(areaName);
            
            let color = COLORS.none;
            if (data) {
                if (showSolar && data.hasSolar) color = COLORS.solar;
                else if (showHeatPump && data.hasHeatPump) color = COLORS.heatpump;
                else if (showEv && data.hasEv) color = COLORS.ev;
            }

            return {
                fillColor: color,
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        /**
         * Logic for interacting with each feature, like popups and highlights.
         */
        function onEachFeature(feature, layer) {
            const areaName = feature.properties.PFA_NAME.substring(0, feature.properties.PFA_NAME.indexOf(' '));
            const data = serviceDataByArea.get(areaName);
            let popupContent = `<b>Postcode Area: ${areaName}</b>`;

            if (data) {
                popupContent += `<br><hr>Service Available Here:`;
                if(data.hasSolar) popupContent += `<br>✔️ Solar Panels`;
                if(data.hasHeatPump) popupContent += `<br>✔️ Heat Pumps`;
                if(data.hasEv) popupContent += `<br>✔️ EV Chargers`;
            } else {
                popupContent += `<br><hr>No service data for this area.`;
            }
            layer.bindPopup(popupContent);

            layer.on({
                mouseover: e => e.target.setStyle({ weight: 3, color: '#333', dashArray: '' }),
                mouseout: e => geoJsonLayer.resetStyle(e.target)
            });
        }

        /**
         * Sets up event listeners for filter checkboxes to re-style the map.
         */
        function setupFilterListeners() {
            document.querySelectorAll('#filter-controls input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    if (geoJsonLayer) {
                        geoJsonLayer.setStyle(styleFeature);
                    }
                });
            });
        }
        
        /**
         * Adds a color legend to the map.
         */
        function addLegend() {
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const labels = ['<strong>Service Priority</strong>'];
                for (const service in COLORS) {
                    if (service !== 'none') {
                        div.innerHTML += labels.push(
                            `<i style="background:${COLORS[service]}"></i> ${service.charAt(0).toUpperCase() + service.slice(1)}`
                        );
                    }
                }
                div.innerHTML = labels.join('<br>');
                return div;
            };
            legend.addTo(map);
        }

        // --- Run the application --- //
        initializeMap();
    </script>
</body>
</html>
